\documentclass[letterpaper,12pt,oneside]{article}
\usepackage[paperwidth=8.5in,paperheight=11in,top=1in,bottom=1in,left=1in,right=1in]{geometry}
\usepackage{setspace}
\usepackage[colorlinks=true,allcolors=Blue]{hyperref}
\usepackage[usenames,dvipsnames]{xcolor}
\usepackage{indentfirst}
\usepackage{titlesec}
\usepackage{multirow}
\usepackage{booktabs}
\usepackage{graphicx}
\usepackage{verbatim}
\usepackage{rotating}
\usepackage{tabularx}
\usepackage{outlines}
\usepackage{lineno}
\usepackage{array}
\usepackage{times}
\usepackage{cleveref}
\usepackage{acronym}
\usepackage[position=t]{subfig}
\usepackage{paralist}
\usepackage[noae]{Sweave}
\usepackage{natbib}
\usepackage{array}
\usepackage{pdflscape}
\usepackage{bm}
\usepackage{showlabels}
\usepackage{outlines}
\bibpunct{(}{)}{,}{a}{}{,}

% page margins and section title formatting
\linespread{1.5}
\setlength{\footskip}{0.5in}
\titleformat*{\section}{\Large\bf\em}
\titleformat*{\subsection}{\singlespace\large\bf}
\titleformat*{\subsubsection}{\singlespace\normalsize\bf\em}
\titlespacing{\section}{0in}{0in}{0in}
\titlespacing{\subsection}{0in}{0in}{0in}
\titlespacing{\subsubsection}{0in}{0in}{0in}

% cleveref options
\crefname{table}{Table}{Tables}
\crefname{figure}{Fig.}{Figs.}
\renewcommand{\figurename}{Fig.}

% aliased citations
% \defcitealias{FLDEP12}{FLDEP 2012}

% acronyms
\acrodef{AIC}{Akaike Information Criterion}
\acrodef{AMJ}{April-May-June}
\acrodef{ARMA}{Autoregressive Moving Average}
\acrodef{chla}[chl-\textit{a}]{chlorophyll \textit{a}}
\acrodef{GAM}{generalized additive models}
\acrodef{JAS}{July-August-September}
\acrodef{JFM}{January-February-March}
\acrodef{OND}{October-November-December}
\acrodef{RMSE}{root mean square error}
\acrodef{USGS}{US Geological Survey}
\acrodef{WRTDS}{weighted regression on time, discharge, and season}

% macros
% for micrograms per litre
\newcommand{\mugl}{$\mu$g L$^{-1}$ }

%knitr options
<<setup,include=F,cache=F>>=
library(knitr)
opts_chunk$set(fig.path = 'figs/', fig.align = 'center', fig.show = 'hold', message = F, echo = F, results = 'asis', dev = 'pdf', dev.args = list(family = 'serif'), fig.pos = '!ht', warning = F)
options(replace.assign = TRUE, width = 90)
@

% get the version based on commit date
<<echo = FALSE, cache = FALSE>>=
raw <- system('git log -1', intern = TRUE)
raw <- raw[grep('^Date', raw)]
raw <- paste('Version', raw)
@

% R libs, set ggplot theme
<<echo = FALSE>>=
library(httr)
library(ggplot2)
library(dplyr)
library(tidyr)
library(scales)
library(wesanderson)
library(grid)
library(gridExtra)
library(Hmisc)
library(mgcv)
library(WRTDStidal)

source('R/funcs.R')

# color palette
cols <- wes_palette('Zissou', 100, 'continuous') %>% 
  as.character %>% 
  .[1:60]
  
# change default ggplot theme
theme_mine <- function (base_size = 12, base_family = "") {
  theme_bw(base_size = base_size, base_family = base_family) %+replace% 
  theme(
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 9), 
    plot.background = element_rect(fill='transparent', 
      colour = NA),
    panel.background = element_rect(fill='transparent', 
      colour = NA),
    legend.background = element_rect(fill='transparent', 
      colour = NA),
    strip.background = element_rect(fill = 
        alpha(cols[length(cols)], 0.5)),
    legend.key = element_rect(fill = 'transparent', 
      colour = NA)
    )   
}
theme_set(theme_mine())
@

% get online bib file
<<echo = FALSE, cache = FALSE>>=
refs <- GET('https://raw.githubusercontent.com/fawda123/refs/master/refs.bib')
refs <- rawToChar(refs$content)
writeLines(refs, con = file('refs.bib'))
@

\begin{document}

\raggedbottom
\linenumbers
\raggedright
\urlstyle{same}
\setlength{\parindent}{0.5in}
\renewcommand\refname{References \vspace{12pt}}

\begin{singlespace}
\title{{\bf {\Large Comparison of weighted regression and additive models for trend evaluation of water quality in tidal waters}}}
\author{
  {\bf {\normalsize Marcus W. Beck$^1$, Rebecca Murphy$^2$}}
  \\\\{\textit {\normalsize $^1$ORISE Research Participation Program}}
  \\{\textit {\normalsize USEPA National Health and Environmental Effects Research Laboratory}}
  \\{\textit {\normalsize Gulf Ecology Division, 1 Sabine Island Drive, Gulf Breeze, FL 32561}}
	\\{\textit {\normalsize Phone: 850-934-2480, Fax: 850-934-2401, Email: \href{mailto:beck.marcus@epa.gov}{beck.marcus@epa.gov}}}
  \\\\{\textit {\normalsize $^2$UMCES at Chesapeake Bay Program}}
	\\{\textit {\normalsize 410 Severn Avenue, Suite 112, Annapolis, MD 21403}}
	\\{\textit {\normalsize Phone: 410-267-9837, Fax: 410-267-5777, Email: \href{mailto:rmurphy@chesapeakbay.net}{rmurphy@chesapeakebay.net}}}
  \vspace{1in} 
  \\ \Sexpr{raw}
	}
\date{}
\maketitle
\end{singlespace}
\clearpage

\section*{Abstract}

\noindent Long-term monitoring datasets provide valuable information to interpret the effects of environmental changes or management actions on ecosystem condition.  The ability to link causal effects with potential changes from observed data can partly depend on the chosen method of trend analysis.  Two statistical approaches, \ac{WRTDS} and \aclu{GAM} (\acp{GAM}), have recently been used to evaluate long-term trends in chlorophyll time series in estuarine systems.  Both models provide a similar approach to trend analysis by using context-dependent parameters or smoothing functions that vary continuously and have the potential to identify multiple drivers of change.  However, the quantitative capabilities of each model, including descriptions of observed and flow-normalized trends, have not been rigorously compared to determine most appropriate use of each model.  We evaluated \ac{WRTDS} and \acp{GAM} using thirty years of data for a monthly time series of chlorophyll in the Patuxent River Estuary, a well-studied tributary to Chesapeake Bay.  Each model was evaluated based on predictive capabilities of the observed data and ability to reproduce flow-normalized trends with simulated data that had statistical properties comparable to the original dataset.  Models were also evaluated based on concordance of conclusions of water quality changes, and causes thereof, in different time periods.  For all examples, prediction errors and average differences between model results were strikingly similar despite differences in computational requirements for each approach.  Flow-normalized trends from each model revealed distinct differences in temporal variation in \ac{chla} from the upper to lower Patuxent estuary.  Mainstem influences of the Chesapeake Bay were apparent with a slight increase in \ac{chla} trends over time in the lower estuary, whereas flow-normalized predictions for the upper estuary showed declines in \ac{chla} followed by an increase in recent years.  Both models had comparable abilities to remove flow effects in simulated time series of \ac{chla}, although flow-normalized predictions to actual data suggested \acp{GAM} results were more stable with minimal observations.  This study provides valuable guidance for using statistical models in trend analysis, with particular relevance for computational requirements, desired products, and future data needs.  

\noindent \textit{Key words}: chlorophyll, estuary, generalized additive models, Patuxent River Estuary, trend analysis, weighted regression

\clearpage

\acresetall

\section{Introduction}

The interpretation of enviromental trends can have widespread implications for the management of natural resources and can facilitate an understanding of ecological factors that mediate system dynamics.  An accurate interpretation of trends can depend on the chosen method of analysis, and more importantly, its ability to consider effects of multiple drivers on response endpoints that may be particular to the system of interest.  The need to interpret potential impacts of nutrient pollution has been a priority issue for managing aquatic resources \citep{Nixon95}, particularly for estuaries that serve as focal points of human activities and receiving bodies for upstream hydrologic networks \citep{Paerl14}.  Common assessment endpoints for eutrophication in estuaries have included seagrass growth patterns \citep{Steward07}, frequency and magnitude of oxygen depletion in bottom waters \citep{Paerl06}, and trophic network connectivity \citep{Powers05}.  Additionally, chlorophyll concentration provides a measure of the release of phytoplankon communities from nutrient limitation with increasing eutrophication.  Chlorophyll time series have been collected for decades in tidal systems (e.g., Tampa Bay, \citet{TBEP11}; Chesapeake Bay, \citet{Harding94}; datasets cited in \citet{Monbet92,Cloern10}), although the interpration of trends in observed data has been problematic given the inherent variability of time series data. Identifying the response of chlorophyll to different drivers, such as management actions or increased pollutant loads, can be confounded by natural variation from freshwater inflows \citep{Borsuk04b} or tidal exchange with oceanic outflows \citep{Monbet92}.  Seasonal and spatial variability of chlorophyll dynamics (see \citet{Cloern96}) can further complicate trend evaluation, such that relatively simple analysis methods may insufficiently describe variation in long-term datasets \citep{Hirsch14b}.  More rigorous quantitative tools are needed to create an unambiguous characterization of chlorophyll response independent of variation from confounding variables.

% WRTDS and GAMs as novel methods
Recent applications of statistical methods to describe water quality dynamics have shown promise in estuaries, specifically \ac{WRTDS} and \acp{GAM}.  The \ac{WRTDS} method was initially developed to describe water quality trends in rivers \citep{Hirsch10,Hirsch14} and has recently been adapted to describe chlorophyll trends in tidal waters \citep{Beck15}.  A defining characteristic of \ac{WRTDS} is a weighting scheme that fits a continuous set of parameters to the time series by considering the influence of location in the record and contextual flow inputs to the period of interest.  The \ac{WRTDS} model has been used to model pollutant delivery from tributary sources to Chesapeake Bay \citep{Hirsch10,Moyer12,Zhang13}, Lake Champlain \citep{Medalie12}, and the Mississippi River \citep{Sprague11}.  A comparison to an alternative regression-based model for evaluating nutrient flux, ESTIMATOR, suggested that \ac{WRTDS} can produce more accurate trend estimates \citep{Moyer12}. Similarly, \acp{GAM} can be used to describe variation in a response variable as a sum of smoothing functions for different predictors \citep{Hastie90,Wood06}.  In applications to water quality time series, \acp{GAM} are similar to \ac{WRTDS} in that variable effects through time can be described in relation to seasonal or annual changes.  Application of \acp{GAM} to describe eutrophication endpoints in tidal waters have not been as extensive as \ac{WRTDS}, although exploratory analyses have suggested that results are comparable.  Moreoever, \acp{GAM} are particularly appealing because they are less computationally intense and provide more accessible estimates of model uncertainty than \ac{WRTDS}.  Despite the potential for both approaches to characterize system dynamics, the relative merits of each have not been evaluated.  Quantitative comparisons that describe the accuracy of empirical descriptions and the desired products could inform the use of each model to describe long-term changes in ecosystem characteristics.

% goals/objectives
The goal of this study is to provide an empirical description of the relative abilities of \ac{WRTDS} and \acp{GAM} to describe long-term changes in time series of eutrophication response endpoints in tidal waters.  A thirty year time series of monthly chlorophyll observations from the Patuxent River Estuary is used as a common dataset for evaluating each model.  The Patuxent Estuary is a well-studied tributary of the Chesapeake Bay system that has been monitored for several decades with fixed stations along the longitudinal axis.  Two stations were chosen as representative time series that differed in the relative contributions of watershed inputs and influences from the mainstem of the Chesapeake, in addition to known historical events that have impacted water quality in the estuary.  The specific objectives of the analysis were to \begin{inparaenum}[1\upshape)]
\item provide a narrative comparison of the statistical foundation of each model, both as a general description and as a means to evaluate water quality time series,
\item use each model to develop an empirical description of water quality changes at each monitoring station given known historical changes in water quality drivers,
\item evaluate each models's ability to reproduce flow-normalized trends as known components of simulated time series, and
\item compare each technique's ability to describe changes, as well as the differences in the information provided by each. 
\end{inparaenum}
We conclude with recommendations on the most appropriate use of each method, with particular attention given to computational requirements, uncertainty assessment, and potential needs for additional monitoring data.

\section{Methods}

\subsection{Study site and water quality data}

% flow data from Bowie, MD gage
<<echo = FALSE>>=
data(bowie_flow)
fl_mean <- format(round(mean(bowie_flow$cms), 1), nsmall = 1)
fl_aggs <- aggregate(cms ~ year, bowie_flow, mean, na.rm = T)
fl_aggs$cms <- format(round(fl_aggs$cms, 1), nsmall = 1)
@

The Patuxent River estuary, Maryland, is a tributary to Chesapeake Bay on the Atlantic coast of the United States (\cref{fig:map}). The longitudinal axis extends 65 km landward from the confluence with the mesohaline portion of Chesapeake Bay.  Estimated total volume at mean low water is 577 x 10$^6$ m$^3$ and a surface area of 126 x 10$^6$ m$^2$.  The lower estuary (below 45 km from the confluence) has a mean width of 2.2 km and depth of 6 m \citep{Cronin75}, whereas the upper estuary has a a mean width of 0.4 km and mean depth of 2.5 m \citep{Hagythes}.  The lower estuary is seasonally stratified and vertically-mixed in the upper estuary.  A two-layer circulation pattern occurs in the lower estuary characterized by an upper seaward-flowing layer and a lower landward-flowing layer.  A mixed diurnal tide dominates with mean range varying from 0.8 m in the upper estuary to 0.4 m near the mouth \citep{Boicourt98}.  The estuary drains a 2300 km$^2$ watershed that is 49\% forest, 28\% grassland, 12\% developed, and 10\% cropland \citep{Jordan03}.  The \ac{USGS} stream gage on the Patuxent River at Bowie, Maryland measures discharge from 39\% of the watershed.  Daily mean discharge from 1985 to 2014 was \Sexpr{fl_mean} m$^3$ s$^{-1}$, with abnormally high years occuring in 1996 (annual mean \Sexpr{fl_aggs[fl_aggs$year == 1996, 'cms']} m$^3$ s$^{-1}$) and 2003 (annual mean \Sexpr{fl_aggs[fl_aggs$year == 2003, 'cms']}  m$^3$ s$^{-1}$). 

The Chesapeake Bay Program maintains a continuous monitoring network for the Patuxent at multiple fixed stations that cover the salinity gradient from estuarine to tidal fresh (\href{http://www.chesapeakebay.net/}{http://www.chesapeakebay.net/}, \cref{fig:map,tab:statsum}).  Water quality samples have been collected since 1985 at monthly or bimonthly intervals and include salinity, temperature, \ac{chla}, dissolved oxygen, and additional dissolved or particulate nutrients and organic carbon.  Seasonal variation in \ac{chla} is observed across the stations with spring and summer blooms occuring in the upper, oligohaline section, whereas primary production is generally higher in the lower estuary during winter months (\cref{fig:chlyrmofl}).  Chlorophyll concentrations are generally lowest for all stations in late fall and early winter.  Periods of low flow are associated with higher chlorophyll concentrations in the upper estuary, whereas the opposite is observed for high flow.  Stations TF1.6 and LE1.2 were chosen as representative time series from different salinity regions to evaluate the water quality models.  Observations at each station capture a longitudinal gradient of watershed influences at TF1.6 to mainstem influences from the Chesapeake Bay at LE1.2.  Long-term changes in chlorophyll have also been related to historical reductions in nutrient inputs following a statewide ban on phosphorus-based detergents in 1984 and wastewater treatment improvements in the early 1990s that reduced point sources of nitrogen \citep{Lung03,Testa08a}.  Therefore, the chosen stations provide unique datasets to evaluate the predictive and flow-normalization abilities of each model given the differing contributions of landward and seaward influences on water quality.

Thirty years of monthly chlorophyll and salinity data from 1986 to 2014 were obtained for stations TF1.6 and LE1.2 from the Chesapeake Bay Program data hub (\href{http://www.chesapeakebay.net/data}{http://www.chesapeakebay.net/data}).  All data were vertically integrated throughout the water column for each date to create a representative sample of water quality.  The integration averaged all values after interpolating from the surface to the maximum depth. Observations at the most shallow and deepest sampling depth were repeated for zero depth and maximum depths, respectively, to bound the interpolations within the range of the data.  Daily flow data were also obtained from the \ac{USGS} stream gage station at Bowie, Maryland and merged with the nearest date in the chorophyll and salinity time series.  Initial analyses suggested that a moving-window average of discharge for the preceding five days provided a better fit to the chlorophyll data at TF1.6, whereas the continuous salinity record was used as a tracer of discharge at LE1.2.  Both chlorophyll and discharge data were log-transformed.  Censored data were not present in any of the data sets.  Initial quality assurance checks for all monitoring data were conducted following standard protocols adopted by the Chesapeake Bay Program.        

\subsection{Model descriptions}

%How, Similarities, differences, optimal smoothing

\subsubsection{Weighted Regression on Time, Discharge, and Season}

The \ac{WRTDS} method relates a response endpoint, typically a nutrient concentration, to discharge and time to evaluate long-term trends \citep{Hirsch10,Hirsch14}. Recent adaptation of \ac{WRTDS} to tidal waters relates chlorophyll concentration to salinity and time \citep{Beck15}, where salinity is a tracer of freshwater inputs or tidal changes.  The functional form of the model is a simple regression that relates the natural log of chlorophyll ($Chl$) to decimal time ($T$) and salinity ($Sal$) on a sinuisoidal annual time scale (i.e., cyclical variation by year). 
\begin{equation} \label{eqn:funform}
\ln\left(Chl\right) = \beta_0 + \beta_1 T + \beta_2 Sal + \beta_3 \sin\left(2\pi T\right) + \beta_4 \cos\left(2\pi t\right) + \epsilon
\end{equation}
The tidal adaptation of \ac{WRTDS} uses quantile regression models \citep{Cade03} to characterize trends in different conditional distributions of chlorophyll, e.g., the median or 90th percentile. For comparison to \acp{GAM}, the original \ac{WRTDS} model in \citet{Hirsch10} that characterizes the conditional mean of the response was used.  Mean models require an estimation of the back-transformation bias parameter for response variables in log-space. This is achieved using the standard error of residuals for each observation along the time series during back-transformation \citep{Hirsch10}.  Additionally, the \ac{WRTDS} model uses survival regression as a variation of the weighted Tobit model \citep{Tobin58} to account for censored observations beyond the detection limit \citep{Hirsch14}.

The \ac{WRTDS} approach obtains fitted values of the response variable by estimating regression parameters for each unique observation. Specifically, a unique regression model is estimated for each point in the period of observation. Each model is weighted by month, year, and salinity (or flow) such that a unique set of regression parameters for each observation is obtained. For example, a weighted regression centered on a single observation weights other observations in the same year, month, and similar salinity with higher importance, whereas observations for different months, years, or salinities receive lower importance. This weighting approach allows estimation of regression parameters that vary in relation to observed conditions throughout the period of record \citep{Hirsch10}. Optimal window widths can be identified using cross-validation, described below, that evaluates the ability of the model to generalize results with novel datasets.

Predicted values are based on an interpolation matrix from the unique regressions at each time step. A sequence of salinity or flow values based on the minimum and maximum values for the data are used to predict chlorophyll using the observed month and year based on the parameters fit to the observation. Model predictions are based on a bilinear interpolation from the grid using the salinity (flow) and date values closest to observed. Salinity- or flow-normalized values are also obtained from the prediction grid that allow an interpretation of chlorophyll trend that is independent of variation related to freshwater inputs. Normalized predictions are obtained for each observation by collecting the sample of observed salinity or flow values that occur for the same month throughout all years in the dataset.  These values are assumed to be equally likely to occur across the time series at that particular month. A normalized value for each point in the time series is the average of the predicted values from each specific model based on the salinity or flow values that are expected to occur for each month.

\subsubsection{Generalized Additive Models}

A \ac{GAM} is a statistical model that allows for a linear predictor to be represented as the sum of multiple smooth functions of covariates \citep{Hastie90}. In this application, \acp{GAM} were constructed with the same explanatory variables as the \ac{WRTDS} approach: log of \ac{chla} was modeled as a function of decimal time, salinity or flow, and day of year (i.e., to capture the annual cycle). The relationships between log-\ac{chla} and the covariates were modeled with thin plate regression splines \citep{Wood06} as the smooth functions using the `mgcv' package in R. To allow for interaction between the model covariates (e.g., seasonal differences in the long-term \ac{chla} pattern), a tensor product basis between all three covariates was constructed. The tensor product basis allows for the smooth construct to be a function of any number of covariates, without an isotropy constraint. The \ac{GAM} implementation in `mgcv' does not require the selection of knots for a spline basis, but instead a reasonable upper limit on the flexibility of the function is set, and a `wiggliness' penalty is added to create a penalized regression spline structure. The balance between model fit and smoothness is achieved by selecting a smoothness parameter that minimizes the generalized cross-validation score \citep{Wood06}.

Model predictions with \acp{GAM} are straightforward to obtain after the model parameters are selected, and can be obtained along with standard errors which are based on the Bayesian posterior covariance matrix \citep{Wood06}. For this comparison, salinity- or flow-normalized \ac{GAM} predictions were obtained in a manner for consistency with \ac{WRTDS}. The observed salinity or flow values were compiled that occurred in the same month throughout all years in the dataset. These values were assumed to be equally likely to occur at that particular month.  A normalized \ac{GAM} estimate at each date in the record was computed as the average of the predictions obtained using all of the flow or salinity values for that month of the year throughout the record. 

\subsubsection{Selection of model parameters}

The selection of optimal model parameters is a challenge that represents a tradeoff between model precision and ability to generalize to novel datasets.  Weighted regression requires identifying optimal half-window widths, whereas the \ac{GAM} approach used here requires identifying an optimal value for a smoothing parameter that weights the wiggliness of the function against model fit \citep{Wood06}.  Overfitting a model with excessively small window widths or smoothing parameter will minimize prediction error but prevent extrapolation of results to different datasets. Similarly, underfitting a model with large window widths or smoothing parameter will reduce precision but will improve the ability to generalize results to different datasets. From a statistical perspective, the optimal model parameters provide a balance between over- and under-fitting.  Both models use a form of cross-validation to identify model parameters that maximize the precision of model predictions with a novel dataset.   

The basic premise of cross-validation is to identify the optimal set of model parameters that minimize prediction error on a dataset that was not used to develop the model.  For the \ac{GAM} approach, generalized cross-validation is used to obtain the optimal smoothing parameter in an iterative process with penalized likelihood maximization to solve for model coefficients. The effective degrees of freedom of the resulting model varies with the smoothing parameter \citep{Wood06}. Similarly, the tidal adaptation of \ac{WRTDS} used k-fold cross-validation to identify the optimal half-window widths. For a given set of half-window widhts, the dataset was separated into ten disjoint sets, such that ten models were evaluated for every combination of k - 1 training and remaining test datasets. That is, the training dataset for each fold was all k - 1 folds and the test dataset was the remaining fold, repeated k times. The average prediction error of the test datasets across k folds provided an indication of model performance for the given combination of half-window widths.  The optimum window widths were those that provided minimum errors on the test data.  Evaluating multiple combinations of window-widths can be computationally intensive. An optimization function was implemented in R  \citep{Byrd95,RDCT15} to more efficiently evaluate model parameters using a search algorithm.  Window widths were searched using the limited-memory modification of the BFGS quasi-Newton method that imposes upper and lower bounds for each parameter.  The chosen parameters were based on a selected convergence tolerance for the error minimization of the search algorithm.  

\subsection{Comparison of modelled trends}

Separate \ac{WRTDS} and \acp{GAM} were created using the above methods for the chlorophyll time series at TF1.6 and LE1.2.  Initial analyses indicated that model performance could be improved using the flow record to model \ac{chla} at TF1.6 and the salinity record to model \ac{chla} at LE1.2.  For each model and station, a predicted and flow-normalized (hereafter flow-normalized refers to both flow and salinity) time series was obtained for comparison.  The results were compared using several summary statistics that evaluated both the predictive performance to describe observed chlorophyll and direct comparisons between the models.  Emphasis was on agreement between observed and predicted values, rather than uncertainty associated with parameter estimates or model results.  As of writing, methods for estimating confidence intervals of \ac{WRTDS} have been developed for the original model \citep{Hirsch15}, but have not been fully developed for application to \ac{WRTDS} in tidal waters.  In addition to simple visual evaluation of trends over time, summary statistics used to compare model predictions to observed \ac{chla} included \ac{RMSE} and average differences.  For all comparisons, \ac{RMSE} comparing each model's predictions to observed \ac{chla} (fit) was defined as:
\begin{equation}
RMSE_{fit} = \sqrt {\frac{{\sum\limits_{{i = 1}}^n {{{\left( {{Chl_i} - {\widehat{Chl}_i}} \right)}^2}} }}{n}}
\end{equation}
where $n$ is the number of observations for a given evaluation, $Chl_i$ is the observed value of \ac{chla} for observation $i$, and ${\widehat{Chl}}_i$ is the predicted value of \ac{chla} for observation $i$.  \ac{RMSE} values closer to zero represent model predictions closer to observed.  Comparisons between models using \ac{RMSE} are similar, such that:
\begin{equation} \label{rmse_fun}
RMSE_{btw} = \sqrt {\frac{{\sum\limits_{{i = 1}}^n {{{\left( {{\widehat{Chl}_{WRTDS,\,i}} - {{\widehat{Chl}}_{GAM,\,i}}} \right)}^2}} }}{n}}
\end{equation}
where the estimated \ac{chla} values for each model, $\widehat{Chl}_{i,\,WRTDS}$ and $\widehat{Chl}_{i,\,GAM}$, are compared directly.  Similarly, average differences (or bias) of predictions between models as a percentage was defined as:
\begin{equation} \label{avediff_fun}
\textrm{Average difference} = \left(\frac{\sum\limits_{i = 1}^n \widehat{Chl}_{WRTDS,\,i} - \sum\limits_{i = 1}^n \widehat{Chl}_{GAM,\,i}}{\sum\limits_{i = 1}^n \widehat{Chl}_{GAM,\,i}}\right) * 100
\end{equation}
Positive values indicate that \ac{WRTDS} provided higher predictions than \acp{GAM} on average, whereas the opposite is true for negative values \citep{Moyer12}.  Results between models were also evaluated using regressions comparing the \ac{WRTDS} and \ac{GAM} predictions.  The regressions were compared to a null model having an intercept of zero and slope of one.  Deviation of either the intercept or slope of the regressions from the null model provided evidence of systematic differences between the models.  In general, an intercept significantly different from zero can be interpreted as an overall difference between the predictions, whereas a slope different from one can be interpreted as a difference that varies with relative magnitude of the predictions.

The statistical comparisons described above were conducted for the entire time series at each station to evaluate overall performance.  Different time periods were also evaluated to identify potential temporal variation in results, which included a comparison of results by annual and seasonal aggregations and periods with different levels of flow using the discharge record at Bowie, Maryland.  Annual and seasonal aggregations shown in \cref{fig:chlyrmofl} were evaluated between the models, in addition to evaluating the models at different levels of flow defined by the quartile distributions (min--25\%, 25\%--median, median--75\%, and 75\%--max).  Flow-normalized time series were compared similarly but only between the models because the true flow-independent component of the observed data is not known and can only be empirically estimated.  As described below, an evaluation of flow-normalized data for each model was accomplished using simulated datasets with known components that were independent of discharge.  However, a simple comparison of flow-normalized trends by different time periods summarized long-term patterns in the Patuxent River estuary.  These comparisons evaluated percent changes of flow-normalized estimates at the beginning and end of each time period.  Percent changes within each period were based on annual mean estimates for the first and last three years of flow-normalized \ac{chla} estimates, excluding the annual aggregations that had limited annual mean data (i.e., seven years per period).  For example, percent change for the \ac{JFM} seasonal period compared an average of JFM annual means for 1986 through 1988 to an average of JFM annual means for 2012 through 2014. This approach was used to reduce the influence of abnormal years or missing data on trend estimates.   

\subsection{Comparison of flow-normalized trends}

The relative abilities of each model to characterize flow-normalized trends in chlorophyll were evaluated using simulated datasets with known components.  This approach was used because the flow-independent component of chlorophyll is typically not observed in raw data such that the true signal must be empirically estimated.  Accordingly, the ability of each model to isolate the flow-normalized trend cannot be evaluated with reasonable certainty unless the true signal is known.  Simulated time series of observed chlrophyll ($Chl_{obs}$) were created as additive components related to flow ($Chl_{flo}$) and a flow-independent biological component of chlorophyll ($Chl_{bio}$):
\begin{equation} \label{chlobs}
Chl_{obs} = Chl_{flo} + Chl_{bio}
\end{equation}
A distinction between $Chl_{flo}$ and $Chl_{bio}$ is that the former describes variation in the observed time series with changes in discharge (e.g., concentration dilution with increased flow) and the latter describes a true, desired measure of chlorophyll in the water column that is directly linked to primary production.  The biological component of chlorophyll is comparable to an observation in a closed system that is not affected by flow and is the time series that is estimated by flow-normalization with \ac{WRTDS} and \acp{GAM}.

The simulated time series was created using methods similar to those in \citet{Hirsch15} and was based on a stochastic model derived from actual flow and water quality measurements to ensure the statistical properties were comparable to existing datasets.  This approach allowed us to evaluate \acp{GAM} and \ac{WRTDS} under different sampling regimes (e.g., monthly rather than daily), while ensuring the simulated datasets had statistical properties that were consistent with known time series. Daily flow observations from the \ac{USGS} stream gage station 01594440 near Bowie, Maryland (38$^{\circ}$57$'$21.3$''$N, 76$^{\circ}$41$'$37.3$''$W) were obtained from 1985 to 2014.  Daily chlorophyll records were obtained from the Jug Bay station (38$^{\circ}$46$'$50.6$''$N, 76$^{\circ}$42$'$29.1$''$W) of the Chesapeake Bay Maryland National Estuarine Research Reserve in the upper Patuxent.  Daily chlorophyll concentrations were estimated from fluorescence values that did not include blue-green algae blooms.  Our primary concern was simulating chlorophyll concentrations at monthly or bimonthly timesteps such that taxa-specific concentrations on a daily time step were not relevant.

Four time series were estimated or simulated from the actual datasets to create the complete, simulated time series:\begin{inparaenum}[1\upshape)]
\item estimated discharge as a stationary seasonal component ($\widehat{Q}_{seas}$),
\item simulated error structure from the residuals of the seasonal discharge model ($\varepsilon_{Q,\,sim}$), 
\item estimated chlorophyll independent of discharge as a stationary seasonal component ($\widehat{Chl}_{seas}$), and
\item simulated error structure from the residuals of the seasonal chlorophyll model ($\varepsilon_{Chl,\,sim}$).
\end{inparaenum}
Unless otherwise noted, chlorophyll and discharge are in ln-transformed units.  Each of the four components was used to simulate the components in \cref{chlobs}:
\begin{equation} \label{chlflo}
Chl_{flo} = I\left(\widehat{Q}_{seas} + \sigma\cdot\varepsilon_{Q,\,sim}\right)
\end{equation}
\begin{equation} \label{chlbio}
Chl_{bio} = \widehat{Chl}_{seas} + \sigma\cdot\varepsilon_{Chl,\,sim}
\end{equation}
The estimated flow time series within the parentheses, $\widehat{Q}_{seas} + \sigma\cdot\varepsilon_{Q,\,sim}$, is floored at zero to simulate an additive effect of increasing flow on $Chl_{obs}$.  Although the actual relationship of water quality measurements with flow is more complex, we assumed that a simple addition was sufficient for the simulations where the primary objective was to create an empirical and linear link between flow and chlorophyll. Moreover, the vector $I$ (where $0 \leq I \leq 1$) can be manually changed to represent an independent effect of flow based on the desired simulation.  For example, a flow effect that changes from non-existent to positive throughout the period of observation can be simulated by creating a vector ranging from zero to one. For the simulated $Chl_{bio}$ time series, the seasonal and error components were characterized using the daily time series at Jug Bay that likely included an effect of flow in the observed data.  For the simulated models, we assumed that the actual flow effect was part of the seasonal component to obtain an accurate estimate of the error component that was independent of both flow and season.  Methods for estimating each of the components in \cref{chlflo,chlbio} are described in detail below.

First, a model for simulating flow-related chlorophyll (\cref{chlflo}) was estimated from the stream gage data as the additive combination of a stationary seasonal component and serially-correlated errors:
\begin{equation} \label{qseas}
Q_{seas} = \beta_0 + \beta_1 \sin\left(2\pi T\right) + \beta_2 \cos\left(2\pi T\right)
\end{equation}
\begin{equation} \label{qerr}
\varepsilon_{Q} = Q_{seas} - \widehat{Q}_{seas}
\end{equation}
A seasonal model of flow was estimated using linear regression for time, $T$, on an annual sinusoidal period (\cref{qseas}).  The residuals from this regression, $\varepsilon_{Q}$ (\cref{qerr}), were used to estimate the structure of the error distribution for simulating the stochastic component of flow.  The error distribution was characterized using an \ac{ARMA} model to identify appropriate $p$ and $q$ coefficients \citep{Hyndman08}.  The parameters were chosen using stepwise estimation for nonseasonal univariate time series that minimized \ac{AIC}.  The resulting coefficients were used to generate random errors from a standard normal distribution for the length of the original time series, $\varepsilon_{Q,\,sim}$.  These stochastic errors were multiplied by the standard deviation of the residuals in \cref{qerr} and added to the seasonal component in \cref{qseas} to create a simulated, daily time series of the flow-component for chlorophyll, $Chl_{flo}$ (\cref{chlflo}).

The chlorophyll time series was created using a similar approach.  The first step estimated the stationary seasonal component of the chlorophyll time series by fitting a \ac{WRTDS} model \citep{Hirsch10} that explicitly included discharge from the gaged station using one year of data from the whole time series:
\begin{equation}\label{chlseas}
Chl_{seas} = \beta_0 + \beta_1 T + \beta_2 Q + \beta_3 \sin\left(2\pi T\right) + \beta_4 \cos\left(2\pi T\right)
\end{equation}
\begin{equation} \label{chlerr}
\varepsilon_{Chl} = Chl_{seas} - \widehat{Chl}_{seas}
\end{equation}
This approach was used to isolate an error structure for simulation that was independent of flow and biology, where the seasonal component (as time $T$ on a sinusoidal annual period) was assumed to be related to biological processes.  The error distribution was then estimated from the residuals (\cref{chlerr}) as before using an \ac{ARMA} estimate of the residual parameters, $p$ and $q$.  Standard error estimates from the regression used at each point in the one-year time series were also retained for each residual.  Errors were simulated ($\varepsilon_{Chl,\,sim}$, \cref{chlbio}) for the entire year using the estimated auto-regressive structure and multiplied by the corresponding standard error estimate from the regression.  The entire year was repeated for every year in the observed time series.  All simulated errors were rescaled to the range of the original residuals that were used to estimate the distribution.  Finally, the simulated flow-component, $Chl_{flo}$, was added to the simulated bilogical model, $Chl_{bio}$, to create the final chlorophyll-flow time series, $Chl_{obs}$, in \cref{chlobs}.  

A daily time series for the entire period of record was simulated using the above methods and then used to compare the relative abilities of \ac{WRTDS} and \acp{GAM} to characterize flow-normalized trends.  Three time series with monthly sampling frequencies and varying contributions of the flow component ($Chl_{flo}$ in \cref{chlobs}) were created from the daily time series (\cref{fig:simex}). One day in each month for each year was randomly sampled and used as the monthly time step for each time series.  Varying effects of the flow component on observed chlorophyll were creating by multiplying $Chl_{flo}$ by different indicator vectors ($I$ in \cref{chlflo}).  The contribution of the flow component varied from non-existent, constant, and steadily increasing.  Respectively, the vector of coefficients applied to each flow component was a constant vector of zeroes, a constant vector of ones, and a linear increase starting at zero and ending at one.  This created three monthly time series that were used to evaluate each model that were analogous to no influence, constant, and changing influence of the flow component over time (\cref{fig:simex}).  Results were evaluated by first comparing the predicted ($\widehat{Chl}_{obs}$) and observed ($Chl_{obs}$) chloropyll values for each simulation, following by comparing the flow-normalized results ($\widehat{Chl}_{bio}$) from each model to the original biological chlorophyll ($Chl_{bio}$) component of each simulated time series (\cref{chlobs,chlbio}).  The former comparison provided information on relative fit to validate the simulated data, whereas the latter comparison to evaluate flow-normalization was the primary focus of the analysis.

\section{Results}

\subsection{Observed trends and relative fit}

<<echo = F>>=
data(bestLE12_wrtds)
data(bestTF16_wrtds)

# days, years, sal/flo
winsLE12 <- attr(bestLE12_wrtds, 'half_wins') %>% 
  unlist %>% 
  form_fun
winsTF16 <- attr(bestTF16_wrtds, 'half_wins') %>% 
  unlist %>% 
  form_fun
@

The optimal half-window widths and degrees of freedom for smoothing varied for \ac{WRTDS} and \acp{GAM}, respectively, at each station.  For \ac{WRTDS}, optimal half-window widths identified by generalized cross-validation were \Sexpr{winsLE12[1]} as a proportion of each year, \Sexpr{winsLE12[2]} years, and \Sexpr{winsLE12[1]} as a proportion of the total range of salinity for LE1.2, and \Sexpr{winsTF16[1]} of each year, \Sexpr{winsTF16[2]} years, and \Sexpr{winsTF16[3]} of flow at TF1.6.  For both stations, the optimization method selected relatively wide windows for the year weights while minimizing the seasonal (annual proportion) and flow component.  For \acp{GAM}, the optimal smoothing procedure resulted in a smoother model at LE1.2 than TF1.6 with effective degrees of freedom of 32.2 and 47.1, respectively.  The tensor product smooth costruct does not split apart the effective degrees of freedom among the three interacting parameters.     

<<echo = FALSE>>=
# data for rmse table of observed to fit by model, site
data(perftoobs)
allrmse <- perftoobs[1, c(2:ncol(perftoobs))]

# perf by station, time period
le12perf <- perftoobs[-1, grepl('cat|LE12', names(perftoobs))] 
names(le12perf) <- c('cat', 'gam', 'wrtds')
le12perf[, -1] <- form_fun(le12perf[, -1])
tf16perf <- perftoobs[-1, grepl('cat|TF16', names(perftoobs))]
names(tf16perf) <- c('cat', 'gam', 'wrtds')
tf16perf[, -1] <- form_fun(tf16perf[, -1])
@

The predicted \ac{chla} from each model generally followed patterns in observed \ac{chla} from 1986 to 2014 (\cref{fig:pred}).  At LE1.2, each model showed seasonal minimum typically in November, whereas maximum \ac{chla} was observed in a spring bloom, typically March or April (\cref{fig:seas}).  A secondary, smaller seasonal peak was also observed in late summer from bottom-layer regeneration and upward nutrient transport \citep{Testa08a}.  Seasonal variation at TF1.6 was noticeably different with an initial peak typically observed in May and a larger dominant bloom occuring in September or October (\cref{fig:seas}).  Elevated \ac{chla}  concentrations were also more prolonged than those at LE1.2 with only a slight decrease between the two seasonal blooms.  A seasonal minimum was typically observed in December or January, followed by a rapid increase in the following months.  Differences in magnitude of the seasonal range were also less prononced at LE1.2 compared to TF1.6, with differences throughout the year approximately 3 \mugl of \ac{chla} at LE1.2 and 7 \mugl of \ac{chla} at TF1.6. Visual evaluation of seasonal trends suggested each model provided similar results, although \ac{WRTDS} predictions had slightly better fits at the extreme ends of the distribution of \ac{chla} (\cref{fig:predmo}).  Normalized predictions for both models were visually distinct from observed predictions such that seasonal minima and maxima and extreme predictions were not common with the normalized values.  Overall, both models had predictions that provided a more adequate visual description of the range of \ac{chla} at TF1.6 as compared to LE1.2 where observed values lower or higher than the predicted values were more common.  

Quantitative summaries of model fit by site indicated that performance between sites and models was similar with \ac{RMSE} ranging from a minimum of \Sexpr{form_fun(min(allrmse))} at TF1.6 for \ac{GAM} predictions and a maximum of \Sexpr{form_fun(max(allrmse))} at TF1.6 for \ac{WRTDS} predictions (\cref{tab:perftoobs}).  Overall, both models performed similarly, although \ac{WRTDS} had slightly better performance at LE1.2 and \acp{GAM} had slightly better performance at TF1.6 (\cref{tab:perftoobs}).  Fit by different time periods generally showed agreement between methods during periods when performance was relatively high or low.  For LE1.2, both models had the worst fit during the 2001-2007 annual period (\ac{RMSE} \Sexpr{with(le12perf, gam[cat == '2001-2007'])} for \acp{GAM}, \ac{RMSE} \Sexpr{with(le12perf, wrtds[cat == '2001-2007'])} for \ac{WRTDS}), the \ac{AMJ} seasonal periods (\Sexpr{with(le12perf, gam[cat == 'AMJ'])} for \acp{GAM}, \Sexpr{with(le12perf, wrtds[cat == 'AMJ'])} for \ac{WRTDS}), and periods of high flow (\Sexpr{with(le12perf, gam[cat == '4 (High)'])} for \acp{GAM}, \Sexpr{with(le12perf, wrtds[cat == '4 (High)'])} for \ac{WRTDS}).  For TF1.6, models had the worst fit during the 1994-2000 annual period (\Sexpr{with(tf16perf, gam[cat == '1994-2000'])} for \acp{GAM}, \Sexpr{with(tf16perf, wrtds[cat == '1994-2000'])} for \ac{WRTDS}) and the \ac{AMJ} seasonal period (\Sexpr{with(tf16perf, gam[cat == 'AMJ'])} for \acp{GAM}, \Sexpr{with(tf16perf, wrtds[cat == 'AMJ'])} for \ac{WRTDS}).  Error rates between models were comparable for all flow periods at TF1.6, with the exception of lower error rates during low flow (\Sexpr{with(tf16perf, gam[cat == '1 (Low)'])} for \acp{GAM}, \Sexpr{with(tf16perf, wrtds[cat == '1 (Low)'])} for \ac{WRTDS}).  In general, model performance was partially linked to flow such that fit was improved during periods of low flow, including seasonal or annual periods of low flow.  For example, both models at both sites had the best fit during the \ac{JAS} period when seasonal flow was minimized (\cref{tab:perftoobs,fig:chlyrmofl}).

<<echo = F>>=
# data from flow-normalized trends table
data(trendsTF16)
data(trendsLE12)
trendsTF16[, 3:6] <- round(trendsTF16[, 3:6], 1)
trendsLE12[, 3:6] <- round(trendsLE12[, 3:6], 1)
@

Results as annual aggregations suggested that \ac{chla} patterns between years have not been constant and are considerably different between sites (\cref{fig:predann}).  Both models showed a gradual and consistent increase in \ac{chla} at LE1.2, with values increasing by approximately 1.5 \mugl from 1986 to 2014.  Predictions at TF1.6 did not show a similar increase from the beginning to the end of the time series, although a dramatic decrease from approximately 12 \mugl to 6 \mugl from 2000 to 2006 was observed. By 2014, chlorophyll returned to values similar to those prior to the initial decrease.  Flow-normalized predictions that were annually averaged at each site allowed an interpretation of trends that were independent of variation in discharge or salinity (\cref{tab:trendsLE12,tab:trendsTF16}).  Overall percent change of \ac{chla} concentration from the beginning to the end of the time series at LE1.2 was approximately 20\% (\cref{tab:trendsLE12}).  A slight decrease in \ac{chla} at TF1.6 was observed from 1986 to 2014 (\cref{tab:trendsTF16}).  Changes by annual, seasonal, and flow time periods at LE1.2 were comparable for each time period and model type, although some differences were observed.  For example, both models had maximum increases in \ac{chla} for the different flow periods for high levels of flow at LE1.2 (\Sexpr{with(trendsLE12, gams_chg[cat %in% "Flow 4 (High)"])}\% for \acp{GAM}, \Sexpr{with(trendsLE12, wrtds_chg[cat %in% "Flow 4 (High)"])}\% for \ac{WRTDS}).  Trends by different time periods were more apparent for TF1.6, particularly as an overall decrease in \ac{chla} for both models during the 2001--2007 period and an overall increase during 2008--2014 period (\cref{tab:trendsTF16}).  Seasonal changes were especially pronounced during the \ac{JFM} and \ac{OND} periods where both models showed an increase and decrease, respectively, with differences between the two (\ac{JFM} period, \Sexpr{with(trendsTF16, gams_chg[cat == 'JFM'])}\% for \acp{GAM}, \Sexpr{with(trendsTF16, wrtds_chg[cat == 'JFM'])}\% for \ac{WRTDS}; \ac{OND} period, \Sexpr{with(trendsTF16, gams_chg[cat == 'OND'])}\% for \acp{GAM}, \Sexpr{with(trendsTF16, wrtds_chg[cat == 'OND'])}\% for \ac{WRTDS}).  Percent changes by flow period were also observed at TF1.6, with the most noticeable difference from LE1.2 being a decrease in \ac{chla} during both high and low flow (both models) and relatively larger increases in \ac{chla} during moderate flow.  

\subsection{Comparison of model predictions}

<<echo = F>>=
data(perfbtw)
perfbtw[ , 2:5] <- round(perfbtw[, 2:5], 2)
@

The following describes direct comparisons of model results, whereas the previous section emphasized results relative to trends over time and fit to the observed data.  Accordingly, direct comparisons were meant to identify instances when models results were systematically different from each other.  \Cref{tab:perfbtw} compares average differences and \ac{RMSE} of results between each model for the complete time series and different subsets by annual, seasonal, and flow periods.  Overall, differences between the models were minor with most percent differences not exceeding 1\% and no \ac{RMSE} values exceeding 0.15.  Model differences between different time periods were not apparent for either station, although the largest average difference was observed at TF1.6 for the 2008--2014 time period (\Sexpr{with(perfbtw, TF16_ave[cat == '2008-2014'])}\%, \ac{WRTDS} greater than \acp{GAM}).

Regressions comparing model results provided additional information about overall differences (significantly different intercept) and differences between the models that varied for different values (significantly different slope) (\cref{tab:regprdnrm}, \cref{fig:regprdnrm}).  Significant differences were observed for the entire time series such that estimated intercepts and slopes were different from zero and one, respectively, for both stations and model predictions (observed and flow-normalized), excluding intercepts and slopes for the flow-normalized predictions at TF1.6 ($\beta_{0,\,norm}$ and $\beta_{1,\,norm}$).  Differences were also observed for the time period subsets, with the most obvious differences occuring for the seasonal aggregations.  For example, all comparisons between the models for both sites and model predictions had intercept estimates significantly greater than zero and slope estimates significantly less than one for the \ac{AMJ} period (\cref{tab:regprdnrm}). Visual comparisons of results in \cref{fig:regprdnrm} confirm those in \cref{tab:regprdnrm}, particularly differences in the seasonal aggregations.

\subsection{Changes in chlorophyll response to flow over time}

Both models described chlorophyll response with sufficient parameterization of input variables to evaluate variation with flow changes over time.  As in \citet{Beck15}, changes in the relationship of \ac{chla} to flow can be evaluated by predicting observed \ac{chla} across the range of observed flow (or salinity) values for each year in the time series.  Visual information obtained from these plots are useful to identify periods of time when \ac{chla} was or was not related to changes in flow and may also lead to the development of hypotheses regarding changes in drivers of primary production, e.g., temporal shifts in point-sources to non-point sources of pollution \citep{Hirsch10,Beck15}.  The only difference between the models in creating the plots is that the three-dimensional prediction grid of \ac{chla}, flow, and time created during model fitting is used for \ac{WRTDS}, whereas the plots for \acp{GAM} are based on post-hoc model predictions with novel data. 

\Cref{fig:dynafig} shows the estimated changes from each model in predicted \ac{chla} for salinity (LE1.2) or flow (TF1.6) across all years in the study period.  The plots are also separated by months of interest to isolate effects of seasonal variation.  Visual assessment of the plots suggests that the relationships were dynamic across the study years and varied considerably between LE1.2 and TF1.6.  For example, the October plots show decreasing sensitivity of \ac{chla} with increasing flow (decreasing salinity) at LE1.2 from early to late in the time series (i.e., a strong, positive relationship changing to a weak relationship over time).  Conversely, the opposite trend is observed at TF1.6 in October such that a weak relationship with flow is observed early in the time series and a strong, negative relationship is observed later in the time series, although overall \ac{chla} has decreased over time.  Additionally, both models provided similar indications of the changes over time, regardless of site or time of year.  However, some differences between the models were observed, particularly for January at LE1.2 where \ac{WRTDS} provided a wider range, or potentially less stable response of \ac{chla} to salinity changes in the earlier years.

\subsection{Flow-normalization with simulated data}

\ac{WRTDS} and \acp{GAM} were fit to each dataset creating six models to evaluate the general fit of observed to predicted ($Chl_{obs} \sim \widehat{Chl}_{obs}$) and biological to flow-normalized \ac{chla} ($Chl_{bio} \sim \widehat{Chl}_{bio}$).  Models were fit using identical methods as those for the Patuxent time series such that an optimal window width combination for \ac{WRTDS} and optimal degrees of freedom for smoothing parameters with \acp{GAM} were identified.  \Cref{fig:dynasim} shows an example of the changing relationships between \ac{chla} and flow across the simulated time series using the results from three optimal \ac{WRTDS} models.  The plots confirm those in \cref{fig:simex} by showing the varying effects of flow in each simulated dataset over time (no effect, constant, increasing) and that the models appropriately characterized the relationships.  For example, a changing response of \ac{chla} to salinity is apparent in the third panel of \cref{fig:dynasim} such that no response is observed early in the time series followed by an increase in the response of \ac{chla} to flow later in the time series.  Similar patterns were observed for the \acp{GAM}.

Comparisons of fit to the simulated time series showed no systematic differenes between the models.  Overall, \ac{WRTDS} results had lower \ac{RMSE} than \acp{GAM} for all comparisons except one ($Chl_{obs} \sim \widehat{Chl}_{obs}$, constant flow simulation), although differences in performance were minor (\cref{tab:simperf}).  Visual comparison of results suggested that both models provided comparable information for predictions of observed values and flow-normalized predictions (\cref{fig:simres}).  Additionally, the varying effect of flow on each time series was apparent in comparisons of predicted with flow-normalized results, such that $\widehat{Chl}_{bio}$ was increasingly different from $\widehat{Chl}_{obs}$ from no effect to constant effect of the flow component (top row, \cref{fig:simres}).  Although both models provided similar performance for individual simulations, differences between the simulations were observed.  The different effects of flow had a negative effect on the ability of each model to remove the flow component.  Comparisons of $Chl_{bio}$ with $\widehat{Chl}_{bio}$ showed the lowest \ac{RMSE} with no flow effect and the highest with a constant flow effect (\cref{tab:simperf}).  Different flow effects did not have an influence on the relationship between predicted ($\widehat{Chl}_{obs}$) and observed ($Chl_{obs}$) \ac{chla} such that \ac{RMSE} for all models and simulations were similar and lower than those comparing the flow-normalized results.  Overall, changing the flow component primarily affected the ability of each model to reproduce the flow-normalized component ($\widehat{Chl}_{bio}$) with relatively minor differences between the models. 

\section{Discussion}

\subsection{Model comparisons and considerations}

The objectives of different statistical models can define methods for comparing relative abilities.  As applied to estuaries, both \ac{WRTDS} and \acp{GAM} have the objective of describing trends from long-term monitoring datasets, whereas practical applications of each model (e.g., hypothesis testing, assessment of management actions, etc.) will be defined by future needs or research objectives.  Accordingly, our comparison methods were chosen based on the exploratory objectives of the analysis and by considering hat each technique provides a potentially novel approach to trend assessment.  We evaluated predictive performance of both observed and flow-normalized trends, comparison between models for potential bias and indications of trend, and descriptions of canonical variation related to temporal or flow effects.  The variety of methods for comparing models can provide different information depending on the desired application.  An improvement in predictive performance using \ac{RMSE}, for example, may suggest one model is more advantageous over another if the goal is to reproduce trends, whereas this information may be irrelevant for hypothesis testing. Inferior performance for one metric does not necessarily invalidate an analysis method for all potential applications.  An interpretation of the results should consider that the analysis provides an overview with several techiques, given that the purpose of each model will be better defined by future applications. 

A general conclusion from our results is that both models provide similar information, both in predictive performance and trends over time in the Patuxent.  The comparisons of \ac{RMSE} consistently showed that \ac{WRTDS} had lower prediction error than \acp{GAM} for all scenarios.  A naive interpretation may suggest that \ac{WRTDS} is a superior model given these results, but we emphasize that the improvement in performance is trivial both in the relative values and differences in the theoretical foundations of each model.  Morever, prediction error for \acp{GAM} could easily be improved over \ac{WRTDS} with only a slight adjustment of model parameters.  This highlights a potential pitfall of using prediction error as a performance metric because the values are sensitive to tuning parameters and the statistical characteristics of a training dataset. To address this issue, comparable methods for model development were implemented to legitimize the comparisons of predictive performance.  Both \ac{WRTDS} and \acp{GAM} used a form of cross-validation to identify an optimal parameter space that minimized the bias-variance tradeoff on separate training and test datasets.  A more generic interpretion of the benefits of cross-validation is that model development is not biased by analyst intervention as the parameters are chosen with predefined heuristics.  Although further development of the technique is needed, this paper presents the first application of a statistical method of selecting optimal window widths for \ac{WRTDS}.  This method allowed for a valid comparison model performance and will likely facilitate future applications of the model to alternative datasets.

The comparisons of predictive performance for each model should also be interpreted relative to the statistical foundations of each model.  The smoothing process in \acp{GAM}, although mathematically involved, rapidly converges to a solution as compared to the fitting process for \ac{WRTDS} that requires a unique regression estimate for every point in the time series.  From a practical perspective, the comparable error estimates for each model's predictions suggests that \acp{GAM} are advantageous because there appears to be little benefit of the added computational time of \ac{WRTDS}.  More surprisingly, the characterization of dynamic changes in flow relationships over time appear comparable for each model.  For example, \cref{fig:dynafig} shows similar information for each model although different methods defined by the models were used to describe \ac{chla} changes over time with variation in salinity or flow.  A simple grid of explanatory variables spanning the distribution space of the observed variables was used as input for the fitted \acp{GAM}, whereas \ac{WRTDS} results in the same figure used each model's fitted interpolation grid.  As such, novel insight into trends over time would be expected with the added computational time required for the \ac{WRTDS} interpolation grids.  Conventional modelling techniques that have a predefined and limited parameter space have been described as `statistical straightjackets' that mold the data to the model.  \ac{WRTDS} is meant to provide a contrasting approach where the data mold the results, as compared to \acp{GAM} that could be considered overconstrained in this context by following a predefined model structure.  The results do not provide a compelling contrast between \acp{GAM} and \ac{WRTDS} despite the statistical differences between the models.  

The interpretation that \ac{WRTDS} does not provide additional insight with the added computational time may be misguided.  A lack of clear differences between each model could have been related to characteristics of the datasets.  The use of data-driven models to identify emergent patterns in the data necessarily requires that these characteristics are real phenomenens that are not readily observed in the raw data.  A logical expectation for trend evaluation is that different methods would lead to similar conclusions for datasets that lack dynamic variation, such as differences between flow relationships and response endpoints over time.  Similarity in results for \ac{WRTDS} and \acp{GAM} could simply mean that relationships between time, season, and flow in the Patuxent are adequately described by the statistical theories of each approach.  A priori site-selection of TF1.6 and LE1.2 was meant to capture a gradient of watershed to mainstem influences on productivity at each location.  The known historical changes from management practices (e.g, wastewater treatment, banning of phosphorus-based detergents) and natural events (e.g., storm events, seagrass recovery) that have affected the Patuxent have also provided a unique context for the time series.  The assumption that these characteristics of the datasets will translate to differences in the model results may have been misguided given that we were not able to show clear differences.  Generalizations of the relative merits of each model should be made sparingly until additional assessments with alternative datasets are made.  Finally, comparability between the two methods may also suggest that both models were equally bad at describing dynamic relationships in the dataset.  An assumption throughout the analysis that is not entirely unreasonable is that both models were equally `good', although the possibility that both were equally inadequate should also be considered as a potential explanation.  Alternative drivers of chlorophyll response that are not explicity included in each model could limit explanatory power if time, season, and discharge were not the dominant predictors of production.  

Although our results generally indicated that comparable information was provided by both models, instances were also observed when different information was provided.  Descriptions of canonical variation of seasonal trends from the model predictions suggested that \ac{WRTDS} more adequately characterized seasonal minima and maxima in chlorophyll production.  Although both similarly described the general structure of seasonal peaks at each station, \ac{WRTDS} provided greater distinction of the secondary seasonal maxima (\cref{fig:seas}, September/October peak at LE1.2, May/June peak at TF1.6).  A post-hoc assessment of seaonal variation at each station showed that \acp{GAM} poorly characterized the secondary seasonal peak during the last ten years of the time series despite the peak being present in the observed data.  A quantitative comparison of predictions by seasonal time periods also suggested that differences between the models were more often observed during specific months within each year (\cref{tab:perfbtw,tab:regprdnrm,fig:regprdnrm}), as compared to variation between different annual or flow periods.  The potential for \ac{WRTDS} to more adequately characterize seasonal variation in \ac{chla} patterns deserves additional attention, particularly if changes in observed \ac{chla} for specific months of the year have occurred at a monitoring station.  \citet{Cloern10} emphasize the importance and potential difficulty of characterizing different components of \ac{chla} variability.  \ac{WRTDS} applied to tidal waters could prove a valuable tool to develop a more comprehensive understanding of spatio-temporal variation in phytoplankton variability.   

Differences between the models may also indicate potential shortcomings, in addition to advantages.  The computationally intensive fitting method for \ac{WRTDS} was expected to allow additional insight into variation of \ac{chla} in response to the primary drivers of time, discharge, and season.  This novel information was investigated several ways, including comparisons of model peformance, evaluations of time periods or flow-normalized trends, or a simple visual distinction between model results.  As noted above, seasonal differences were observed between the models, whereas the additional comparisons suggested both methods provided comparable information.  However, initial assessment of \cref{fig:dynafig} suggested that \ac{WRTDS} provided a more dynamic description of \ac{chla} response to changes in flow or salinity over time for specific locations in the record.  For example, \ac{chla} response over time to salinity changes during January at LE1.2 shows \ac{WRTDS} describing greater variation than \acp{GAM}, particularly for lower salinity values.  Additional investigation suggested that these `novel' descriptions were related to low sample size for the specific location in the record causing instability in the model predictions.   Accordingly, \ac{WRTDS} descriptions may be unstable at extreme or uncommon locations in the data domain where the number of observations with non-zero weights may be limited.  Methods for \ac{WRTDS} have been developed to address this issue (i.e., automated window width increases with low sample sizes), although they were not implemented for the current analysis due to complications during model fitting and interpretations of trend comparisons with \acp{GAM}.    

\subsection{Patuxent trends}

Both models provided a detailed description of water quality changes in the Patuxent River estuary.  Although our primary objective was to evaluate the quantitative capabilities of each model, several trends were described that deserve additional investigation.  Each model described distinct trends at TF1.6 and LE1.2 that were linked to changes over time and discharge, having implications for assessing the effects of additional factors related to ecosystem condition.  Annual trends at TF1.6 showed a substantial decrease in \ac{chla} that lasted several years, followed by a gradual increase to concentrations similar to those earlier in the time series.  By comparison, annual trends in the lower estuary at LE1.2 showed a consistent, linear increase over time.  Seasonal patterns and trends related to different flow periods were also described by the models.  Spring blooms were commonly observed in the lower estuary, whereas late summer blooms were observed in the upper estuary.  Trends related to different flow periods were less obvious, although large increases in \ac{chla} were observed for moderate flow levels.  Trends in \Cref{fig:dynafig} can facilitate an interpretation of changes at each station related to flow effects over time.  For example, annual trends in October suggested that the association between flow (decreasing salinity) and \ac{chla} have weakened over time at LE1.2.  By contrast, trends at TF1.6 showed an increasingly negative relationship between flow and \ac{chla} over time.  Both models also showed changes in the shape of the relationship between \ac{chla} and discharge.  For example, a distinct non-linear relationship between \ac{chla} and increasing disharge (decreasing salinity) was observed for January predictions at LE1.2 earlier in the record, whereas the trend became increasingly linear near the end of the record.

Although an investigation of the specific causes of water quality changes in the Patuxent is beyond the scope of our analysis, the model results can be used to hypothesize causal links in the context of temporal and flow variation.  Previous studies have linked changes in flow relationships over time to shifts in sources of nutrient pollution \citep{Hirsch10,Beck15}.  Specific results for the Patuxent could be related to historical changes in nutrient loading, such as the banning of phosphorus-based detergents in the mid 1980s and wastewater treatment plant upgrades in the early 1990s \citep{Lung03,Testa08a}.  An investigation of chlorophyll response to both flow changes and ratios of point-source to non-point sources of nutrients could provide valuable information on system dynamics.  Historical changes in flow have also had noticeable impacts on water quality in the Patuxent.  A drought period from 1999 to 2002 contributed to increases in \ac{chla} in the upper estuary and decreases in the lower estuary.  By contrast, storm events have been linked to lower \ac{chla} from estuarine flushing or shifts in concentration along the longitudinal axis.  The model results partially confirm the observed changes in \ac{chla} with flow changes, particularly in the tidal fresh portion of the upper estuary.  The substantial decline in \ac{chla} in the early 2000s coincides with storm events, including the passage of Hurricane Isabel in 2003.  However, low concentrations persisted for several years suggesting that additional factors may have had separate or additive effects on \ac{chla} response.  For example, seagrass growth patterns in the upper estuary have followed a similar but inverse pattern as \ac{chla} with an increase in growth in the late 1990s and early 2000s, followed by a decline in recent years after a peak in coverage in 2005 (J. M. Testa, personal communication).  This correlation with \ac{chla} suggests nutrient sequestration by seagrasses following a shift in primary production, although definitive links have yet to be shown.       

\subsection{Conclusions}

The use of data-driven statistical techniques that leverage the descriptive potential of long-term monitoring datasets continues to be a relevant focus of research and management efforts in aquatic systems.  Both \ac{WRTDS} and \acp{GAM} are actively being developed for application to monitoring time series and our analysis represents the first quantitative comparison of \ac{WRTDS} and \acp{GAM} to evaluate water quality trends in tidal waters.  For the Patuxent River estuary, both models had surprisingly similar abilties to describe observed and flow-normalized trends in \ac{chla} response over time.  \ac{WRTDS} always out-performed \acp{GAM} based on prediction error alone, although the relative differences were trivial considering computational differences between the models.  Some differences in the descriptive capabilities were observed, including potentially different indications of canonical seasonal variation or specific periods of the time series where data limitations may have caused instability in model predictions.  Our application to simulated datasets with known flow-independent components of chlorophyll provided further indications of similarities between the two approaches.  

Practical applications of each model should consider additional characteristics in addition to simple quantitative comparisons described above.  The use of \ac{WRTDS} to describe water quality trends in tidal waters, particularly with monthly or bimonthly time series, is a novel application for which the model was never intended.  \cite{Hirsch10} developed the original model for streams and rivers for high-resolution daily time series where time, discharge, and season are dominant characteristics that influence water quality.  Although seasonal and flow effects are important drivers of change in estuaries, other physical or biological characteristics may be equally or more important.  As such, recent use of \acp{GAM} in tidal waters has followed a different paradigm where drivers of change are not necessarily known and the time series typically has a larger time step with occasional discontinuous intervals \citep[E. S. Perry, personal communication,][]{Harding15}.  Although we have quantitatively compared each method to inform decision-making, choosing a technique should also consider characteristics of the dataset, question of interest, or study system.  Each model can also provide different products, which we have not specifically addressed above given constraints on similarly comparing each model.  For example, confidence intervals that can facilitate hypothesis-testing are readily available \acp{GAM}, whereas similar products are not yet available for tidal adaptation of \ac{WRTDS} \cite[but see][]{Hirsch15}.  Accordingly, the results herein provide a partial description of \ac{WRTDS} and \acp{GAM} that should be considered in a broader context for water quality assessment.

%%%%%%
% refs
\clearpage
\begin{singlespace}
\bibliographystyle{apalike_mine}
\bibliography{refs}
\end{singlespace}
\clearpage

%%%%%%
% tables

% site characteristics of TF16, LE12, tab:statsum
<<eval = T, echo = F, cache = T>>=
data(pax_meta)
data(pax_data)

# summarize pax_data
totab <- group_by(pax_data, STATION) %>% 
  summarise(
    lnchla = mean(lnchla, na.rm = TRUE), 
    sal = mean(sal, na.rm = TRUE)
  ) %>% 
  left_join(pax_meta, ., by = 'STATION') %>% 
  rename(
    Station = STATION, 
    Lat = LAT, 
    Long = LONG,
    Segment = CBSEG_2003_DESCRIPTION, 
    `Distance (km)` = dist_km, 
    `Depth (m)` = depth_m, 
    `ln-Chl (\\mugl)` = lnchla, 
    `Sal (ppt)` = sal
  ) %>% 
  mutate(Segment = tolower(gsub('^PATUXENT RIVER-|[[:space:]]REGION$', '', Segment))) %>% 
  select(-CBSEG_2003) %>% 
  mutate(
    Lat = form_fun(Lat), 
    Long = form_fun(Long),
    `Distance (km)` = form_fun(`Distance (km)`, 1),
    `ln-Chl (\\mugl)` = form_fun(`ln-Chl (\\mugl)`), 
    `Sal (ppt)` = form_fun(`Sal (ppt)`), 
    Segment = factor(Segment, levels = c('tidal fresh', 'oligohaline', 'mesohaline'), labels = c('TF', 'OH', 'MH')),
    Station = gsub('LE1.2', '{\\\\bf LE1.2}', Station),
    Station = gsub('TF1.6', '{\\\\bf TF1.6}', Station)
  )
    
cap.val <- 'Summary characteristics of monitoring stations on the Patuxent River estuary.  Chlorophyll and salinity values are based on averages from 1986 to 2014.  Stations used for the analysis are in bold.  Segments are salinity regions in the Patuxent for the larger Chesapeake Bay area (TF = tidal fresh, OH = oligohaline, MH = mesohaline).  See \\cref{fig:map} for site locations.'

# table
latex(
  totab[, -1],
  file = '',
  caption.loc = 'top',
  caption = cap.val,
  rowname = totab[, 1],
  rowlabel = 'Station',
  label = 'tab:statsum',
  col.just = rep('l', ncol(totab[, -1]))
  )
  
@

% performance summary of predictions to observed, tab:perftoobs
<<eval = T, echo = F, cache = T>>=
data(bestLE12)
data(bestTF16)

alldat <- rbind(
  data.frame(bestLE12, stat = 'LE12', stringsAsFactors = F), 
  data.frame(bestTF16, stat = 'TF16', stringsAsFactors = F)
  ) 

# summarize by categories, then combine with overall summary
totab_sep <- select(alldat, 
    stat, chla, fits_wrtds, fits_gams, res_wrtds, res_gams, flcat, mocat, yrcat
  ) %>% 
  mutate(
    flcat = as.character(flcat),
    mocat = as.character(mocat),
    yrcat = as.character(yrcat)
  ) %>% 
  gather(key = 'cats', value = 'cat', flcat:yrcat) %>% 
  mutate(cat = factor(cat, 
    levels = c('1986-1993', '1994-2000', '2001-2007', '2008-2014', 'JFM', 'AMJ', 'JAS', 'OND', 'Flow 1 (Low)', 'Flow 2', 'Flow 3', 'Flow 4 (High)'), 
    labels = c('1986-1993', '1994-2000', '2001-2007', '2008-2014', 'JFM', 'AMJ', 'JAS', 'OND', '1 (Low)', '2', '3', '4 (High)')
    )
  ) %>% 
  group_by(cat, stat) %>% 
  summarise(
    wrtds_rmse = rmse.fun(res_wrtds),
    wrtds_dev = sum(res_wrtds^2, na.rm = TRUE),
    gam_rmse = rmse.fun(res_gams),
    gam_dev = sum(res_gams^2, na.rm = TRUE)
  )

# get comparisons for all obs
totaball <- group_by(alldat, stat) %>% 
  summarise(
    wrtds_rmse = rmse.fun(res_wrtds), 
    wrtds_dev = sum(res_wrtds^2, na.rm = TRUE), 
    gam_rmse = rmse.fun(res_gams),
    gam_dev = sum(res_gams^2, na.rm = TRUE)
  )

# add all obs to period comparisons, combine rmse and dev in same column, make long format
totab <- rbind(
  data.frame(cat = '', totaball), 
  totab_sep
  ) %>%
  mutate(
    wrtds = paste0(form_fun(wrtds_rmse), ' (', form_fun(wrtds_dev, 1, 1, 1, trim = TRUE), ')'),
    gam = paste0(form_fun(gam_rmse), ' (', form_fun(gam_dev, 1, 1, 1, trim = TRUE), ')')
  ) %>% 
  select(-matches('_dev$|_rmse$')) %>%  
  gather('mod', 'rmse', wrtds:gam) %>% 
  unite('res', stat, mod) %>% 
  spread(res, rmse)

# for inline S expressions
perftoobs <- rbind(
  data.frame(cat = '', totaball), 
  totab_sep
  ) %>%
  select(-wrtds_dev, - gam_dev) %>% 
  rename(wrtds = wrtds_rmse, gam = gam_rmse) %>% 
  gather('mod', 'rmse', wrtds:gam) %>% 
  unite('res', stat, mod) %>% 
  spread(res, rmse)
save(perftoobs, file = 'data/perftoobs.RData')

# latex table
tab <- totab[, -1]
rows <- totab[, 1]
cap.val<-'Summaries of model performance using \\ac{RMSE} of observed to predicted ln-chlorophyll for each station (LE1.2 and TF1.6).  Deviance for each model as the sum of squared residuals is shown in parentheses. Overall performance for the entire time series is shown at the top with groupings by different time periods below.  Time periods are annual groupings every seven years (top), seasonal groupings by monthly quarters (middle), and flow periods based on quantile distributions of discharge.'

latex( 
  tab,
  file = '',
  rowlabel = 'Period',
  caption = cap.val,
  caption.loc = 'top',
  rgroup = c('All', 'Annual', 'Seasonal', 'Flow'),
  n.rgroup = c(1, rep(4, 3)),
  cgroup = c('LE1.2', 'TF1.6'),
  n.cgroup = c(2, 2),
  rowname = rows,
  colheads = rep(c('GAM', 'WRTDS'), 2),
  label = 'tab:perftoobs'
  )

@

% trend summary of flo-norm results for WRTDS/GAMs, two tables each station, tab:trendsLE12, tab:trendsTF16
<<eval = T, echo = F, cache = T>>=
data(bestLE12)
data(bestTF16)

# combine stations, agg by year for slope ests
alldat <- rbind(
  data.frame(bestLE12, stat = 'LE12', stringsAsFactors = F), 
  data.frame(bestTF16, stat = 'TF16', stringsAsFactors = F)
  ) %>% 
  select(stat, date, norm_wrtds, norm_gams, mocat, yrcat, flcat) %>% 
  mutate(
    date = as.numeric(strftime(date, '%Y'))
  )
  
# these need to be aggregated separately

# annual aggs
yrdat <- group_by(alldat, stat, date, yrcat) %>% 
  summarise(
    norm_wrtds = mean(norm_wrtds, na.rm = T), 
    norm_gams = mean(norm_gams, na.rm = T)
  ) 

# monthly aggs
modat <- group_by(alldat, stat, date, mocat) %>% 
  summarise(
    norm_wrtds = mean(norm_wrtds, na.rm = T), 
    norm_gams = mean(norm_gams, na.rm = T)
  )

# flo aggs
fldat <- group_by(alldat, stat, date, flcat) %>% 
  summarise(
    norm_wrtds = mean(norm_wrtds, na.rm = T), 
    norm_gams = mean(norm_gams, na.rm = T)
  )

# get summary stats for each agg period

# percent change across period
# based on differences between average of earliest three and latest three years
# to minimize outliers
# use single = T to use only one year for first and last comparisons
chn_fun <- function(x, y, single = F){

  tomod <- data.frame(x, y)
  tomod <- tomod[order(tomod$x), ]
  
  # get only first and last year's data
  if(single){
  
    srt <- tomod[which.min(tomod$x), 'y']
    stp <- tomod[which.max(tomod$x), 'y']
  
  # otherwise get average of first and last three years of data
  } else {
    
    srt <- which.min(tomod$x)
    srt <- seq(srt, srt + 2)
    srt <- mean(tomod[srt, 'y'], na.rm = TRUE)
    stp <- which.max(tomod$x)
    stp <- seq(stp - 2, stp)
    stp <- mean(tomod[stp, 'y'], na.rm = TRUE)
      
  }
  
  # get percent change from beginning to end
  out <- 100 * (stp - srt)/srt
  return(out)
  
}

yrdat <- gather(yrdat, 'mod', 'val', norm_wrtds:norm_gams) %>% 
  mutate(mod = gsub('^norm_', '', mod)) %>% 
  group_by(stat, yrcat, mod) %>% 
  summarise(
    ave = mean(val, na.rm = TRUE),
    chg = chn_fun(date, val, single = T) # important!
  ) %>% 
  gather('met', 'val', ave:chg) %>% 
  unite('modmet', mod, met) %>% 
  spread(modmet, val) %>% 
  rename(cat = yrcat)

modat <- gather(modat, 'mod', 'val', norm_wrtds:norm_gams) %>% 
  mutate(mod = gsub('^norm_', '', mod)) %>% 
  group_by(stat, mocat, mod) %>% 
  summarise(
    ave = mean(val, na.rm = TRUE),
    chg = chn_fun(date, val)
  ) %>% 
  gather('met', 'val', ave:chg) %>% 
  unite('modmet', mod, met) %>% 
  spread(modmet, val) %>% 
  rename(cat = mocat)

fldat <- gather(fldat, 'mod', 'val', norm_wrtds:norm_gams) %>% 
  mutate(mod = gsub('^norm_', '', mod)) %>% 
  group_by(stat, flcat, mod) %>% 
  summarise(
    ave = mean(val, na.rm = TRUE),
    chg = chn_fun(date, val)
  ) %>% 
  gather('met', 'val', ave:chg) %>% 
  unite('modmet', mod, met) %>% 
  spread(modmet, val) %>% 
  rename(cat = flcat)

# summary across all years
allsum <- gather(alldat, 'mod', 'val', norm_wrtds:norm_gams) %>% 
  mutate(mod = gsub('^norm_', '', mod)) %>% 
  group_by(stat, date, mod) %>% 
  summarise(
    val = mean(val, na.rm = TRUE)
  ) %>% 
  group_by(stat, mod) %>% 
  summarise(
    ave = mean(val, na.rm = TRUE),
    chg = chn_fun(date, val)
  ) %>% 
  gather('met', 'val', ave:chg) %>% 
  unite('modmet', mod, met) %>% 
  spread(modmet, val) %>% 
  mutate(cat = '') %>% 
  select(stat, cat, gams_ave, gams_chg, wrtds_ave, wrtds_chg)

totab <- rbind(allsum, yrdat, modat, fldat) %>% 
  mutate(cat = factor(cat, levels = c('', '1986-1993', '1994-2000', '2001-2007', '2008-2014', 'JFM', 'AMJ', 'JAS', 'OND', 'Flow 1 (Low)', 'Flow 2', 'Flow 3', 'Flow 4 (High)'))) %>% 
  arrange(stat, cat) %>% 
  data.frame(.)

# for inline expressions
trendsLE12 <- totab[totab$stat %in% 'LE12', ]
trendsTF16 <- totab[totab$stat %in% 'TF16', ]
save(trendsLE12, file = 'data/trendsLE12.RData')
save(trendsTF16, file = 'data/trendsTF16.RData')

# latex table, LE12
tabLE12 <- form_fun(totab[totab$stat %in% 'LE12', -c(1:2)])
rows <- totab[totab$stat %in% 'LE12', 2]
cap.val <- 'Summaries of flow-normalized trends from each model at LE1.2 for different time periods.  Summaries are averages and percentage changes of ln-chlorophyll (\\mugl) based on annual means within each category.  For example, summary values for high flow for a given model and are based on instances of high flow across years.  Percentage changes are the differences between the last and first years in the periods.  Time periods are annual groupings every seven years (top), seasonal groupings by monthly quarters (middle), and flow periods based on quantile distributions of discharge.'

latex( 
  tabLE12,
  file = '',
  rowlabel = 'Period',
  caption = cap.val,
  caption.loc = 'top',
  rgroup = c('All', 'Annual', 'Seasonal', 'Flow'),
  n.rgroup = c(1, rep(4, 3)),
  cgroup = c('GAM', 'WRTDS'),
  n.cgroup = c(2, 2),
  rowname = rows,
  colheads = rep(c('Ave.', '\\% Change'), 2),
  label = 'tab:trendsLE12'
)

# latex table, TF1.6
tabTF16 <- form_fun(totab[totab$stat %in% 'TF16', -c(1:2)])
rows <- totab[totab$stat %in% 'TF16', 2]
cap.val <- 'Summaries of flow-normalized trends from each model at TF1.6 for different time periods.  Summaries are averages and percentage changes of ln-chlorophyll (\\mugl) based on annual means within each category.  For example, summary values for high flow for a given model and are based on instances of high flow across years.  Percentage changes are the differences between the last and first years in the periods.  Time periods are annual groupings every seven years (top), seasonal groupings by monthly quarters (middle), and flow periods based on quantile distributions of discharge.'

latex( 
  tabTF16,
  file = '',
  rowlabel = 'Period',
  caption = cap.val,
  caption.loc = 'top',
  rgroup = c('All', 'Annual', 'Seasonal', 'Flow'),
  n.rgroup = c(1, rep(4, 3)),
  cgroup = c('GAM', 'WRTDS'),
  n.cgroup = c(2, 2),
  rowname = rows,
  colheads = rep(c('Ave.', '\\% Change'), 2),
  label = 'tab:trendsTF16'
)
    
@

% performance summary of models to each other, tab:perfbtw
<<eval = T, echo = F, cache = T>>=
data(bestLE12)
data(bestTF16)

alldat <- rbind(
  data.frame(bestLE12, stat = 'LE12', stringsAsFactors = F), 
  data.frame(bestTF16, stat = 'TF16', stringsAsFactors = F)
  ) 

totab <-select(alldat, 
    stat, fits_wrtds, fits_gams, flcat, mocat, yrcat
  ) %>% 
  mutate(
    flcat = as.character(flcat),
    mocat = as.character(mocat),
    yrcat = as.character(yrcat)
  ) %>% 
  gather(key = 'cats', value = 'cat', flcat:yrcat) %>% 
  mutate(cat = factor(cat, levels = c('1986-1993', '1994-2000', '2001-2007', '2008-2014', 'JFM', 'AMJ', 'JAS', 'OND', 'Flow 1 (Low)', 'Flow 2', 'Flow 3', 'Flow 4 (High)'))
  ) %>% 
  group_by(cat, stat) %>% 
  summarise(
    rmse = rmse.fun(fits_wrtds, fits_gams),
    ave = ave.fun(fits_wrtds, fits_gams)
  )

# get comparisons for all obs
totaball <- group_by(alldat, stat) %>% 
  summarise(
    rmse = rmse.fun(fits_wrtds, fits_gams), 
    ave = ave.fun(fits_wrtds, fits_gams)
  )

# add all obs to period comparisons, make long format
totab <- rbind(
  data.frame(cat = '', totaball), 
  totab
  ) %>% 
  gather('met', 'val', rmse:ave) %>% 
  unite('res', stat, met) %>% 
  spread(res, val)

perfbtw <- totab
save(perfbtw, file = 'data/perfbtw.RData')

# latex table
tab <- form_fun(totab[, -1])
rows <- totab[, 1]
cap.val <- 'Comparison of predicted results between \\ac{WRTDS} and \\acp{GAM} using average differences (\\%) and \\ac{RMSE} values at each station.  Overall comparisons for the entire time series are shown at the top with groupings by different time periods below.  Time periods are annual groupings every seven years (top), seasonal groupings by monthly quarters (middle), and flow periods based on quantile distributions of discharge. Negative percentages indicate \\ac{WRTDS} predictions were lower than \\ac{GAM} predictions (\\cref{avediff_fun}).'

latex( 
  tab,
  file = '',
  rowlabel = 'Period',
  caption = cap.val,
  caption.loc = 'top',
  rgroup = c('All', 'Annual', 'Seasonal', 'Flow'),
  n.rgroup = c(1, rep(4, 3)),
  cgroup = c('LE1.2', 'TF1.6'),
  n.cgroup = c(2, 2),
  rowname = rows,
  colheads = rep(c('Ave. diff.', '\\ac{RMSE}'), 2),
  label = 'tab:perfbtw'
)

@

% regression fit between WRTDS, GAMs, predictions and norms, tab:regprdnrm
<<eval = T, echo = F, cache = T>>=
data(bestLE12)
data(bestTF16)

diffLE12 <- select(bestLE12, 
    fits_wrtds, fits_gams, norm_wrtds, norm_gams, flcat, mocat, yrcat
  ) %>% 
  mutate(
    flcat = as.character(flcat),
    mocat = as.character(mocat),
    yrcat = as.character(yrcat)
  ) %>% 
  gather(key = 'cats', value = 'cat', flcat:yrcat) %>% 
  mutate(cat = factor(cat, levels = c('1986-1993', '1994-2000', '2001-2007', '2008-2014', 'JFM', 'AMJ', 'JAS', 'OND', 'Flow 1 (Low)', 'Flow 2', 'Flow 3', 'Flow 4 (High)')),
    stat = 'LE1.2'
  )

diffTF16 <- select(bestTF16, 
    fits_wrtds, fits_gams, norm_wrtds, norm_gams, flcat, mocat, yrcat
  ) %>% 
  mutate(
    flcat = as.character(flcat),
    mocat = as.character(mocat),
    yrcat = as.character(yrcat)
  ) %>% 
  gather(key = 'cats', value = 'cat', flcat:yrcat) %>% 
  mutate(cat = factor(cat, levels = c('1986-1993', '1994-2000', '2001-2007', '2008-2014', 'JFM', 'AMJ', 'JAS', 'OND', 'Flow 1 (Low)', 'Flow 2', 'Flow 3', 'Flow 4 (High)')),
    stat = 'TF1.6'
  )

# summmarize by categories, predictions
dat <- rbind(diffTF16, diffLE12) %>% 
  group_by(cat, stat)

intpred <- summarise(dat,
    pint = lm.fun(fits_wrtds, fits_gams, origin = FALSE)[1]
  ) %>%
  mutate(stat = paste0('pint', stat)) %>% 
  spread('stat', 'pint')

slopred <- summarise(dat,
    pslo = lm.fun(fits_wrtds, fits_gams, origin = FALSE)[2]
  ) %>%
  mutate(stat = paste0('pslo', stat)) %>% 
  spread('stat', 'pslo')

intnorm <- summarise(dat,
    nint = lm.fun(norm_wrtds, norm_gams, origin = FALSE)[1]
  ) %>%
  mutate(stat = paste0('nint', stat)) %>% 
  spread('stat', 'nint')

slonorm <- summarise(dat,
    nslo = lm.fun(norm_wrtds, norm_gams, origin = FALSE)[2]
  ) %>%
  mutate(stat = paste0('nslo', stat)) %>% 
  spread('stat', 'nslo')


dat <- left_join(intpred, slopred, by = 'cat') %>% 
  left_join(., intnorm, by = 'cat') %>% 
  left_join(., slonorm, by = 'cat')

# add summary for whole time series, predictions
totab <- rbind(
  data.frame(
    cat = '', 
    pintLE1.2 = with(bestLE12, lm.fun(fits_wrtds, fits_gams, origin = FALSE))[1], 
    pintTF1.6 = with(bestTF16, lm.fun(fits_wrtds, fits_gams, origin = FALSE))[1],
    psloLE1.2 = with(bestLE12, lm.fun(fits_wrtds, fits_gams, origin = FALSE))[2], 
    psloTF1.6 = with(bestTF16, lm.fun(fits_wrtds, fits_gams, origin = FALSE))[2],
    nintLE1.2 = with(bestLE12, lm.fun(norm_wrtds, norm_gams, origin = FALSE))[1], 
    nintTF1.6 = with(bestTF16, lm.fun(norm_wrtds, norm_gams, origin = FALSE))[1],
    nsloLE1.2 = with(bestLE12, lm.fun(norm_wrtds, norm_gams, origin = FALSE))[2], 
    nsloTF1.6 = with(bestTF16, lm.fun(norm_wrtds, norm_gams, origin = FALSE))[2]
    ),
  dat
)

# latex table
tab <- totab[, -1]
rows <- totab[, 1]
cap.val <- "Regression fits comparing predicted ({\\it pred}) and flow-normalized ({\\it norm}) results for \\ac{WRTDS} and \\acp{GAM} at each station.  Values in bold-italic are those where the intercept ($\\beta_0$) estimate was significantly different from zero or the slope ($\\beta_{1}$) estimate was significantly different from one. Fits for the entire time series are shown at the top.  Time periods are annual groupings every seven years (top), seasonal groupings by monthly quarters (middle), and flow periods based on quantile distributions of discharge.  See \\cref{fig:regprdnrm} for a graphical summary."

latex( 
  tab,
  file = '',
  rowlabel = 'Period',
  caption = cap.val,
  caption.loc = 'top',
  rgroup = c('All', 'Annual', 'Seasonal', 'Flow'),
  n.rgroup = c(1, rep(4, 3)),
  cgroup = c('$\\beta_{0,\\,pred}$', '$\\beta_{1,\\,pred}$', '$\\beta_{0,\\,norm}$', '$\\beta_{1,\\,norm}$'),
  n.cgroup = rep(2, 3, 4),
  rowname = rows,
  colheads = rep(c('LE1.2', 'TF1.6'), 4),
  label = 'tab:regprdnrm'
  )

@

% comparison of flow-normalized results for simulated datasets, tab:simperf
<<eval = T, echo = F, cache = T>>=
data(simres)

# rename factor labels for each simulation
simres <- mutate(simres, 
  sim = factor(sim, levels = c('sim2', 'sim1', 'sim3'), labels = c('No flow', 'Constant flow', 'Increasing flow'))
)

# compare predicted to simulated obs chl and norm bio to actual bio
totab <- group_by(simres, sim, mod) %>% 
  summarise(
    obs_rmse = rmse.fun(simval, fits), 
    obs_dev = sum((simval - fits)^2, na.rm = TRUE),
    bio_rmse = rmse.fun(lnchla_noQ, norm),
    bio_dev = sum((lnchla_noQ - norm)^2, na.rm = TRUE)
  ) %>% 
  ungroup %>% 
  mutate(
    obs = paste0(form_fun(obs_rmse), ' (', form_fun(obs_dev, 1, 1, 1, trim = TRUE), ')'),
    bio = paste0(form_fun(bio_rmse), ' (', form_fun(bio_dev, 1, 1, 1, trim = TRUE), ')')
  ) %>% 
  select(-matches('_dev$|_rmse$')) %>%  
  data.frame

# latex table
tab <- totab[, -c(1:2)]
rows <- totab[, 2]
cap.val<-'Summaries of model performance comparing observed chlorophyll with predicted values ($Chl_{obs} \\sim \\widehat{Chl}_{obs}$) and biological chlorophyll with flow-normalized values ($Chl_{bio} \\sim \\widehat{Chl}_{bio}$) for the three simulated time series (no flow, constant flow, and increasing flow effect).  Summaries are \\ac{RMSE} values comparing results from each model (\\ac{GAM}, \\ac{WRTDS}) in the bottom two rows of panels in \\cref{fig:simres}. Deviance for each model as the sum of squared residuals is shown in parentheses.'

latex( 
  tab,
  file = '',
  rowlabel = 'Simulations',
  caption = cap.val,
  caption.loc = 'top',
  rgroup = c('No flow', 'Constant flow', 'Increasing flow'),
  n.rgroup = rep(2, 3),
  rowname = rows,
  colheads = c('$Chl_{obs} \\sim \\widehat{Chl}_{obs}$', '$Chl_{bio} \\sim \\widehat{Chl}_{bio}$'),
  label = 'tab:simperf'
  )
@

%%%%%%
% figures

% study site map
<<map, fig.height = 7, fig.width = 5, cache = T, out.width = '0.7\\textwidth', fig.cap = 'Patuxent River estuary with Chesapeake Bay inset. Fixed locations monitored by the Chesapeake Bay Program at monthly frequencies are shown along the longitudinal axis with distance from the mouth (km).  Study sites are in bold. Salinity regions in the Patuxent for the larger Chesapeake Bay area are also shown (TF = tidal fresh, OH = oligohaline, MH = mesohaline). See \\cref{tab:statsum} for a numeric summary of station characteristics.', echo = FALSE>>=

# load data
data(cb_poly)
data(usa_poly)
data(patux_poly)
data(pax_meta)

# lims <- bbox(patux_poly)

# color palette
mapcols <- wes_palette('Zissou', 100, 'continuous') %>% 
  as.character %>% 
  .[1:60]
mapcols <- mapcols[round(seq(1, length(mapcols), length = 3))]

# prep for plots
cb_poly <- fortify(cb_poly)
usa_poly <- fortify(usa_poly)
patux_poly <- fortify(patux_poly) %>% 
  mutate(id = factor(id, levels = c('60', '74', '88'), labels = c('TF', 'OH', 'MH')))

pax_meta$lab <- with(pax_meta, paste0('"', STATION, ' (', round(dist_km, 1), ')"'))
pax_meta$lab[c(4, 8)] <- paste0('bold(', pax_meta$lab[c(4, 8)], ')') 

# base map
p1 <- ggplot(patux_poly, aes(x = long, y = lat)) + 
  geom_polygon(data = cb_poly, aes(x = long, y = lat, group = group), 
    fill = 'grey90', colour = 'grey50') +
  geom_polygon(aes(fill = factor(id), group = group), colour = NA) +
  scale_fill_manual(values = rev(mapcols)) +
  geom_point(data = pax_meta, aes(x = LONG, y = LAT), size = 5, alpha = 0.8) +
  geom_text(data = pax_meta, aes(x = LONG * 1.001, y = LAT, label = lab), size = 5, 
    parse = TRUE) +
  theme_classic() + 
  theme(axis.line=element_blank(), axis.text.x=element_blank(),
          axis.text.y=element_blank(), axis.ticks=element_blank(),
          axis.title.x=element_blank(),
          axis.title.y=element_blank(),
          panel.background=element_blank(),panel.border=element_blank(),panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),plot.background=element_blank(), 
          legend.position = 'top', 
          legend.title = element_blank()
    ) +
  coord_fixed(ratio = 1, xlim = c(-76.84, -76.38), ylim = c(38.27, 38.88))


# inset
p2 <- ggplot(patux_poly, aes(x = long, y = lat)) + 
  geom_polygon(data = usa_poly, aes(x = long, y = lat, group = group), 
    fill = 'white', colour = 'grey50') +
  geom_polygon(aes(group = group), colour = 'black', fill = 'black') +
  theme(axis.title =element_blank(), 
          axis.text.y = element_text(colour = 'black'), 
          axis.text.x = element_text(colour = 'black', angle = 90, vjust = 0.5), 
          panel.background=element_rect(fill = 'grey90'),
          panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),
          plot.background=element_blank(),
          panel.border = element_rect(colour = "black", fill = NA, size = 1)
    ) +
  coord_fixed(ratio = 1, xlim = c(-77.5, -75.5), ylim = c(36.7, 39.7))

grid.newpage()
v1 <- viewport(width = 1, height = 1, x = 0.5, y = 0.5) 
v2 <- viewport(width = 0.55, height = 0.55, x = 0.7275, y = 0.64)
print(p1, vp = v1) 
print(p2, vp = v2)

@

% chlorophyll trends by year, month, flow, combined
<<chlyrmofl, fig.width = 5, fig.height = 7.75, eval = T, echo = F, cache = T, fig.cap = 'Annual, seasonal, and flow differences in chlorophyll trends at each monitoring station in the Patuxent River Estuary.  Size and color are proportional medians of ln-chlorophyll-a by year, season, and flow categories. See \\cref{fig:map} for station numbers.'>>=
load(file = 'data/pax_data.RData')
load(file = 'data/pax_meta.RData')
load(file = 'data/pax_clip.RData')

# color for water for continuity with last fig
wt_col <- wes_palette('Zissou', 100, 'continuous')[10] %>% 
  alpha(0.6)

# format pax_meta for mrg with pax_plo
pax_meta <- select(pax_meta, STATION, LONG, LAT) %>% 
  mutate(STATION = as.character(STATION))

# add month, yr columns, make categories by yr, mo, fl
pax_data <- mutate(pax_data, 
  mo = as.numeric(strftime(date, '%m')),
  yr = as.numeric(strftime(date, '%Y'))
  ) %>% 
  mutate(STATION = as.character(STATION)) %>% 
  mutate(
    yrcat = cut(yr, breaks = c(-Inf, 1993, 2000, 2007, Inf), 
      labels = c('1986-1993', '1994-2000', '2001-2007', '2008-2014')),
    mocat = cut(mo, breaks = c(-Inf, 3, 6, 9, Inf), labels = c('JFM', 'AMJ', 'JAS', 'OND')), 
    flcat = cut(lnQ, breaks = c(-Inf, quantile(lnQ, c(0.25, 0.5, 0.75)), Inf), labels = c('Flow 1 (Low)', 'Flow 2', 'Flow 3', 'Flow 4 (High)'))
  )
  
# get yrcat medians by station, add coords
pax_yr <- group_by(pax_data, STATION, yrcat) %>% 
  summarise(lnchla = median(lnchla, na.rm = T)) %>% 
  left_join(., pax_meta, by = 'STATION') %>% 
  rename(cat = yrcat)

# get mocat medians by station, add coords
pax_mo <- group_by(pax_data, STATION, mocat) %>% 
  summarise(lnchla = median(lnchla, na.rm = T)) %>% 
  left_join(., pax_meta, by = 'STATION') %>% 
  rename(cat = mocat)

# get flocat medians by station, add coords
pax_fl <- group_by(pax_data, STATION, flcat) %>% 
  summarise(lnchla = median(lnchla, na.rm = T)) %>% 
  left_join(., pax_meta, by = 'STATION') %>% 
  rename(cat = flcat)

pax_plo <- rbind(pax_yr, pax_mo, pax_fl)

# plot label
ylabs <- expression(paste('ln-Chl-',italic(a),' (',italic('\u03bc'),'g ',L^-1,')'))

# station labels, first panel only
text_lab <- filter(data.frame(pax_plo), STATION %in% c('TF1.6', 'LE1.2') & cat %in% '1986-1993')

# plot
p1 <- ggplot(pax_meta, aes(x = LONG, y = LAT)) + 
  geom_polygon(data = pax_clip, aes(x = long, y = lat, group = group),
    fill = wt_col) +
  coord_map(
    xlim = c(-76.78, -76.36),
    ylim = c(38.27, 38.85)
  ) +
  geom_text(data = text_lab, aes(x = LONG + 0.09, y = LAT, label = STATION), size = 2.5) + 
  geom_point(data = pax_plo, aes(group = cat, size = lnchla, fill = lnchla), 
    pch = 21) +
  facet_wrap(~cat, ncol = 4) +
  theme_mine() + 
  scale_size(range = c(1, 9)) + 
  scale_fill_gradientn(colours = cols) +
  theme(
    legend.position = 'top', 
    axis.title = element_blank(), 
    axis.text.y = element_text(size = 7),
    axis.text.x = element_text(size = 7, angle = 90, hjust = 1)
    ) + 
  guides(
    fill = guide_legend(title = ylabs), 
    size = guide_legend(title = ylabs)
    )
p1
@

% predicted trends for each mod - monthly time series of observed with predictions, RMSE in fig
<<eval = T, echo = F, cache = T, message = F, results = 'hide'>>=
library(dplyr)
library(ggplot2)
library(tidyr)

data(bestLE12)
data(bestTF16)

# some plots
bestTF16$site <- 'TF1.6'
bestLE12$site <- 'LE1.2'
names(bestLE12) <- gsub('gams$', 'GAM', names(bestLE12))
names(bestLE12) <- gsub('wrtds$', 'WRTDS', names(bestLE12))
names(bestTF16) <- gsub('gams$', 'GAM', names(bestTF16))
names(bestTF16) <- gsub('wrtds$', 'WRTDS', names(bestTF16))

bestLE12 <- select(bestLE12, -sal, -lnQ, -dec_time)
bestTF16 <- select(bestTF16, -lnQ, -sal, -dec_time)
toplo <- rbind(bestTF16, bestLE12) %>% 
  gather(variable, value, fits_WRTDS:res_GAM) %>% 
  separate(variable, c('output', 'model'), sep = '_') %>% 
  mutate(output = factor(output, levels = c('fits', 'norm', 'res'), labels = c('Pred', 'Norm', 'Res')))

p1 <- ggplot(toplo[toplo$output != 'Res', ], aes(x = date, y = value, colour = output)) + 
  geom_point(aes(y = chla, shape = 'Obs'), colour = 'black', size = 1.5, alpha = 0.3) +
  geom_line(size = 0.8, alpha = 0.85) + 
  facet_wrap(site ~ model) + 
  ylab(expression(paste('ln-Chl ',' (',italic('\u03bc'),'g ',L^-1,')'))) + 
  theme(
    axis.text.x = element_text(size = 8, angle = 90, vjust = 0.5),
    axis.title.x = element_blank(), 
    legend.title = element_blank()
    ) +
  scale_y_continuous(limits = c(0, 4.5), breaks = c(0.5, 1.5, 2.5, 3.5, 4.5)) + 
  scale_colour_manual(values = cols[c(1, length(cols))]) + 
  guides(color=guide_legend(override.aes=list(shape=c(NA,NA),linetype=c(1,1))))

toplo2 <- mutate(toplo, year = as.numeric(strftime(date, '%Y'))) %>% 
  group_by(year, site, output, model) %>% 
  summarise(value = mean(value, na.rm = TRUE)) %>% 
  filter(output != 'Res') %>% 
  spread(output, value) 

p2 <- ggplot(toplo2, aes(x = year, y = Pred, colour = 'Pred')) + 
  geom_line(aes(x = year, y = Norm, colour = 'Norm'), size = 1) + 
  geom_point() + 
  facet_wrap(site ~ model) + 
  theme(
    axis.text.x = element_text(size = 8, angle = 90, vjust = 0.5),
    axis.title.x = element_blank(), 
    legend.title = element_blank()
    ) +
  scale_y_continuous(limits = c(1.5, 3), breaks = seq(1.5, 3, 0.5)) + 
  scale_colour_manual(values = cols[c(length(cols), 1)]) + 
  ylab(expression(paste('ln-Chl ',' (',italic('\u03bc'),'g ',L^-1,')'))) +
  guides(color=guide_legend(override.aes=list(shape=c(NA,16),linetype=c(1,0))))

pdf('figs/predmo.pdf', height = 4, width = 9, family = 'serif')
print(p1)
dev.off()

pdf('figs/predann.pdf', height = 4, width = 9, family = 'serif')
print(p2)
dev.off()

@

\begin{figure}
\centering
\subfloat[Monthly]{
\includegraphics[width=\textwidth]{figs/predmo.pdf}
\label{fig:predmo}
}

\subfloat[Annual]{
\includegraphics[width=\textwidth]{figs/predann.pdf}
\label{fig:predann}
}

\caption{Predicted chlorophyll from generalized additive models (GAM) and weighted regression (WRTDS) for LE1.2 and TF1.6 stations on the Patuxent River estuary.  \cref{fig:predmo} shows results at monthly time steps and \cref{fig:predann} shows results averaged by year.  Values in blue are model predictions and values in yellow are flow-normalized predictions.}
\label{fig:pred}
\end{figure}

% plot of seasonal variation from model predictions, by model and site, 
<<seas, echo = FALSE, eval = T, cache = F, message = F, results = 'hide', fig.width = 9, fig.height = 5, fig.cap = 'Seasonal variation from observed and model predictions of \\ac{chla} by station.  Predictions are points by day of year from 1986 to 2014.  The blue line is a loess (locally estimated) polynomial smooth to characterize the seasonal components.'>>=

data(bestLE12)
data(bestTF16)

bestLE12 <- mutate(bestLE12, stat = 'LE1.2')
bestTF16 <- mutate(bestTF16, stat = 'TF1.6')

toplo <- rbind(bestLE12, bestTF16) %>% 
  select(date, fits_wrtds, fits_gams, chla, stat) %>% 
  mutate(
    Year = '2014', 
    mo = as.numeric(strftime(date, '%m')),
    day = as.numeric(strftime(date, '%d')),
    fake_date = as.Date(paste(Year, mo, day, sep = '-'))
  ) %>% 
  gather('mod', 'val', fits_wrtds:chla) %>% 
  mutate(
    mod = factor(mod, levels = c('chla', 'fits_gams', 'fits_wrtds'), 
      labels = c('observed', 'GAM', 'WRTDS'))
  )
  
ylab <- expression(paste('ln-Chl ',' (',italic('\u03bc'),'g ',L^-1,')'))
xlab <- 'Day of year'

ggplot(toplo, aes(x = fake_date, y = val, group = mod)) + 
  geom_point(pch = 1, col = cols[40]) + 
  stat_smooth(method = 'loess', span = 0.4, se = F, col = cols[1], size = 1) +
  scale_y_continuous(ylab) + 
  scale_x_date(xlab, labels = date_format("%m/%d")) + 
  facet_grid(stat ~ mod, scales = 'free_y') + 
  theme_mine() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 8))
@

% wrtds v gam predictions by periods
<<regprdnrm, fig.width = 6, fig.height = 6.5, eval = T, echo = F, cache = T, fig.cap = 'Comparison of \\ac{WRTDS} and \\acp{GAM} results at each station (LE1.2, TF1.6) and different time periods.  Predicted and flow-normalized results are shown.  Time periods are annual groupings every seven years (top), seasonal groupings by monthly quarters (middle), and flow periods based on quantile distributions from the discharge record (low).  Regression lines for each model result and 1:1 replacement lines (thin grey) are also shown.  See \\cref{tab:regprdnrm} for parameter estimates of regression comparisons.'>>=

data(bestLE12)
data(bestTF16)

bestLE12 <- select(bestLE12, 
    fits_wrtds, fits_gams, norm_wrtds, norm_gams, flcat, mocat, yrcat, dec_time
  ) %>% 
  gather(., 'var', 'val', fits_wrtds:norm_gams) %>% 
  separate(., var, c('res', 'mod'), by = '_') %>% 
  spread(mod, val) %>% 
  mutate(stat = 'LE1.2')

bestTF16 <- select(bestTF16, 
    fits_wrtds, fits_gams, norm_wrtds, norm_gams, flcat, mocat, yrcat, dec_time
  ) %>% 
  gather(., 'var', 'val', fits_wrtds:norm_gams) %>% 
  separate(., var, c('res', 'mod'), by = '_') %>% 
  spread(mod, val) %>% 
  mutate(stat = 'TF1.6')

toplo <- rbind(bestTF16, bestLE12)
toplo$res <- factor(toplo$res, levels = c('fits', 'norm'), labels = c('Pred', 'Norm'))

# margins
mars <- grid::unit(c(0, 0, 0, 0), 'cm')

p <- ggplot(toplo, aes(x = gams, y = wrtds, colour = res, group = res)) + 
  geom_abline(intercept = 0, slope = 1, colour = 'grey') + 
  geom_point(aes(shape = res), alpha = 0.6, size = 1) + 
  scale_colour_manual(values = cols[c(1, 50)]) +
  scale_shape_manual(values = c(1, 1)) + 
  scale_x_continuous(limits = c(0, 4)) + 
  scale_y_continuous(limits = c(0, 4)) + 
  geom_smooth(method = 'lm', se = F, size = 0.7, fullrange = TRUE, alpha = 0.7)  + 
  theme(axis.title.x = element_blank(), axis.title.y = element_blank(), legend.position = 'top', 
    legend.title = element_blank()) 

pleg <- g_legend(p)
p <- p + 
  theme(legend.position = 'none')

p1 <- p + facet_grid(stat ~ yrcat) + theme(plot.margin = mars)
p2 <- p + facet_grid(stat ~ mocat) + theme(plot.margin = mars)
p3 <- p + facet_grid(stat ~ flcat) + theme(plot.margin = mars)

ylab <- expression(paste('WRTDS, ln-Chl ',' (',italic('\u03bc'),'g ',L^-1,')'))
xlab <- expression(paste('GAM, ln-Chl ',' (',italic('\u03bc'),'g ',L^-1,')'))

grid.arrange(pleg, p1, p2, p3, left = textGrob(ylab, rot = 90), bottom = textGrob(xlab),
  heights = c(0.12, 1, 1, 1))

@

% dynaplots for each mod (as in Fig. 8 Beck and Hagy 2015)
<<dynafig, fig.cap = 'Changes in the relationship between \\ac{chla} and freshwater inputs (salinity decrease, flow increase) across the time series.  Separate panels are shown for each station (LE1.2, TF1.6), model type (GAM, WRTDS), and chosen months.  Changes over time are shown as different predictions for each year in the time series (1986 to 2014).  Salinity was used as a tracer of freshwater inputs at LE1.2, whereas the flow record at Bowie, Maryland was used at TF1.6.  The scales of salinity and flow are reversed for comparison of trends. Units are proportions of the total range in the observed data with values in each plot truncated by the monthly 5\\textsuperscript{th} and 95\\textsuperscript{th} percentiles.', eval = T, fig.height = 6.5, fig.width = 7.5, out.width = '1.02\\textwidth'>>=

## LE12 models

data(bestLE12)

LE12_tomod <- select(bestLE12, date, dec_time, chla, sal) %>% 
  mutate(
    doy = as.numeric(strftime(date, '%j'))
  )

bestLE12_gam <- gam(chla~te(dec_time, doy, sal, bs=c("tp","cc","tp")), k = c(5, 8, 5), data = LE12_tomod, knots=list(doy=c(1,366)))

data(bestLE12_wrtds)

## TF16 models

data(bestTF16)

TF16_tomod <- select(bestTF16, date, dec_time, chla, lnQ) %>% 
  mutate(
    doy = as.numeric(strftime(date, '%j'))
  ) %>% 
  rename(sal = lnQ)

bestTF16_gam <- gam(chla~te(dec_time, doy, sal, bs=c("tp","cc","tp")), k = c(5, 10, 5), 
  data = TF16_tomod, 
  knots=list(doy=c(1,366)), na.action = na.pass)

data(bestTF16_wrtds)

## plots
margs <- grid::unit(c(0, 0, 0, -4), "mm") # margins
fac_txt <- 10 # facet text size
ylims <- c(0.6, 4)
col_vec <- cols
mos <- c(1, 4, 7, 10)
alph <- 0.7

p1 <- dynagam(bestLE12_gam, LE12_tomod, ncol = 1, use_bw = F, month = mos, col_vec = col_vec, alpha = alph) +
  theme(legend.position = 'none', axis.title.y = element_blank(), 
    strip.text.x = element_text(size = fac_txt), plot.margin = margs) +
  scale_y_continuous(limits = ylims) +
  scale_x_reverse('Salinity')

p2 <- dynaplot(bestLE12_wrtds, ncol = 1, use_bw = F, month = mos, col_vec = col_vec, alpha = alph) +
  theme(legend.position = 'none', axis.title.y = element_blank(), 
    strip.text.x = element_text(size = fac_txt), axis.text.y = element_blank(), 
    axis.ticks.y = element_blank(), plot.margin = margs) +
  scale_y_continuous(limits = ylims) +
  scale_x_reverse('Salinity')

p3 <- dynagam(bestTF16_gam, TF16_tomod, ncol = 1, use_bw = F, month = mos, col_vec = col_vec, alpha = alph) +
  theme(legend.position = 'none', axis.title.y = element_blank(), 
    strip.text.x = element_text(size = fac_txt), axis.text.y = element_blank(), 
    axis.ticks.y = element_blank(), plot.margin = margs) + 
  scale_x_continuous('Flow') +
  scale_y_continuous(limits = ylims)

p4 <- dynaplot(bestTF16_wrtds, ncol = 1, use_bw = F, month = mos, col_vec = col_vec, alpha = alph) +
  theme(axis.title.y = element_blank(), legend.position = 'right', 
    strip.text.x = element_text(size = fac_txt), axis.text.y = element_blank(), 
    axis.ticks.y = element_blank(), plot.margin = margs) + 
  scale_x_continuous('Flow') +
  scale_y_continuous(limits = ylims) + 
  guides(colour = guide_colourbar(barwidth = 1, barheight = 10)) 
 
pleg <- g_legend(p4)
p4 <- p4 + theme(legend.position = 'none')

ylab <- expression(paste('ln-Chl-',italic(a),' (',italic('\u03bc'),'g ',L^-1,')'))

# arrange all as grob
grobwidths <- c(1, 1, 1, 1)
library(grid)

grid.arrange(
  arrangeGrob(textGrob(ylab, rot = 90)), 
  arrangeGrob(
    arrangeGrob(textGrob('LE1.2'), textGrob('TF1.6'), ncol = 2), 
    arrangeGrob(textGrob('GAM'), textGrob('WRTDS'), textGrob('GAM'), textGrob('WRTDS'), ncol = 4), 
    arrangeGrob(p1, p2, p3, p4, ncol = 4), 
    heights = c(0.025, 0.05, 1)
  ),
  arrangeGrob(pleg), 
  ncol = 3, 
  widths = c(0.2, 2, 0.3)
  )

@

% examples of simulated datasets for eval of flow-normalization - daily, monthly, different flow effects
<<simex, fig.width = 6, fig.height = 7, eval = T, echo = F, cache = T, fig.cap = 'Examples of simulated time series for evaluating flow-normalized results from \\ac{WRTDS} and \\acp{GAM}.  The plots show the simulated daily time series (points) and monthly samples (lines) from the daily time series used to evaluate the flow-normalized predictions from \\ac{WRTDS} and \\acp{GAM}.  From top to bottom, the time series show the biological \\ac{chla} independent of flow and the three simulated datasets that represent different effects of flow: none, constant, and increasing effect.  The flow-normalized results for the simulated monthly time series from each model were compared to the first time series (biological chlorophyll) that was independent of flow.'>>=

# load data, from sim_dat.R in tidal_comp proj
load('data/sims_day.RData')
load('data/sims_mos.RData')

# organize daily and monthly ts for plots
toplo <- select(sims_day, date, lnchla_noQ, sim2, sim1, sim3) %>% 
  tidyr::gather('variable', 'value', -date)
toplo2 <- select(sims_mos, date, lnchla_noQ, sim2, sim1, sim3) %>% 
  tidyr::gather('variable', 'value', -date) 

# factor labels as expressions
labs <- c('Biological chlorophyll', 'No flow', 'Constant flow', 'Increasing flow')
levels(toplo$variable) <- levels(toplo2$variable) <- labs

# y axis labels
ylab <- expression(paste('ln-Chl ',' (',italic('\u03bc'),'g ',L^-1,')'))

# merge with sampled
ggplot(toplo, aes(x = date, y = value, group = variable)) + 
  geom_point(pch = 1, size = 1, col = cols[40]) + 
  geom_line(data = toplo2, aes(x = date, y = value, group = variable), col = cols[1]) +
  scale_y_continuous(ylab) + 
  theme(axis.title.x = element_blank()) +
  facet_wrap(~variable, ncol = 1)
@

% dynaplot examples for mods with simulated data
<<dynasim, echo = F, cache = T, fig.height = 2.5, fig.width = 7, fig.cap = 'Examples of changing relationships between \\ac{chla} (\\mugl) and flow (as proportion of the total range) over time (2005--2015) for each simulated time series in \\cref{fig:simex}.  The plots are based on August predictions from three \\ac{WRTDS} models for each time series to illustrate the simulated relationships between flow and chlorophyll.', eval = T>>=
# color palette
cols <- wes_palette('Zissou', 100, 'continuous') %>% 
  as.character %>% 
  .[1:60]
modcols <- cols[c(1, 50)]
  
data(bestsim_wrtds)

lims <- c(0.85, 3)
mars <- grid::unit(c(0, 0, 0, 0), 'cm')

# no effect
p1 <- dynaplot(bestsim_wrtds[[2]], month = 8, col_vec = cols, fac_nms = 'No flow') + 
  scale_y_continuous(limits = lims) +
  theme_mine() +
  theme(legend.position = 'none', axis.title = element_blank(), plot.margin = mars, 
    strip.text.x = element_text(size = NULL))

# constant
p2 <- dynaplot(bestsim_wrtds[[1]], month = 8, col_vec = cols, fac_nms = 'Constant flow') + 
  scale_y_continuous(limits = lims) +
  theme_mine() +
  theme(legend.position = 'none', axis.title = element_blank(), plot.margin = mars)

# increasing
p3 <- dynaplot(bestsim_wrtds[[3]], month = 8, col_vec = cols, fac_nms = 'Increasing flow') + 
  scale_y_continuous(limits = lims) +
  theme_mine() +
  theme(legend.position = 'top', axis.title = element_blank(), plot.margin = mars) +
  guides(colour = guide_colourbar(barwidth = 10, barheight = 1)) 

pleg <- g_legend(p3)
p3 <- p3 + theme(legend.position = 'none')

ylabs <- expression(paste('ln-Chl-',italic(a),' (',italic('\u03bc'),'g ',L^-1,')'))

grid.arrange(
  pleg,
  arrangeGrob( 
    textGrob(ylabs, rot = 90), p1, p2, p3, ncol = 4, widths = c(0.1, 1, 1, 1)), 
  textGrob('Flow'),
  heights = c(0.35, 1, 0.1)
)
@

% results of flow-normalized data for simulations
<<simres, echo = F, cache = T, fig.height = 6, fig.width = 6, fig.cap = 'Model predictions for three simulated datasets with different flow contributions (none, constant, increasing).  Estimated variables (e.g., $\\widehat{Chl}_{bio}$) are compared to simulated variables (e.g., $Chl_{bio}$) to evaluate the ability of each model (\\acp{GAM} and \\ac{WRTDS}) to recreate the flow-normalized time series of chlorophyll (i.e., bottom plot, $\\widehat{Chl}_{bio}$ vs $Chl_{bio}$) after removing a simulated flow component from the observed chlorophyll time series ($Chl_{obs}$).', eval = T>>=
# color palette
cols <- wes_palette('Zissou', 100, 'continuous') %>% 
  as.character %>% 
  .[1:60]
modcols <- cols[c(1, 50)]
  
data(simres)

# rename factor labels for each simulation
simres <- mutate(simres, 
  sim = factor(sim, levels = c('sim2', 'sim1', 'sim3'), labels = c('No flow', 'Constant flow', 'Increasing flow'))
)

# plot margins
mars <- grid::unit(c(0, 0, 0, 0), 'cm')

# plot limits
lims <- c(0, 4)

# # simulated observed vs simulated norms
# p1 <- ggplot(simres, aes(x = simval, y = lnchla_noQ)) +
#   geom_abline(intercept = 0, slope = 1) +
#   scale_x_continuous(quote(italic('Chl' [obs])), limits = lims) + 
#   scale_y_continuous(quote(italic('Chl' [bio])), limits = lims) + 
#   geom_point(colour = 'black', shape = 1) + 
#   scale_colour_manual(values = modcols) +
#   facet_wrap(~sim, ncol = 3) +
#   theme(legend.position = 'none', plot.margin = mars)

# fits vs norms
p2 <- ggplot(simres, aes(x = fits, y = norm)) +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(quote(italic(widehat('Chl') [obs])), limits = lims) + 
  scale_y_continuous(quote(italic(widehat('Chl') [bio])), limits = lims) + 
  geom_point(aes(colour = mod), shape = 1) + 
  scale_colour_manual(values = modcols) +
  facet_wrap(~sim, ncol = 3) +
  theme(legend.position = 'none', plot.margin = mars)

# fits vs simulated observed
p3 <- ggplot(simres, aes(x = fits, y = simval)) +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(quote(italic(widehat('Chl') [obs])), limits = lims) + 
  scale_y_continuous(quote(italic('Chl' [obs])), limits = lims) +   
  geom_point(aes(colour = mod), shape = 1) + 
  scale_colour_manual(values = modcols) +
  facet_wrap(~sim, ncol = 3) + 
  theme(legend.position = 'none', plot.margin = mars)

# norms vs simulated norms
p4 <- ggplot(simres, aes(x = norm, y = lnchla_noQ)) +
  geom_abline(intercept = 0, slope = 1) +
  scale_x_continuous(quote(italic(widehat('Chl') [bio])), limits = lims) + 
  scale_y_continuous(quote(italic('Chl' [bio])), limits = lims) + 
  geom_point(aes(colour = mod), shape = 1) + 
  scale_colour_manual(values = modcols) +
  facet_wrap(~sim, ncol = 3) + 
  theme(legend.position = 'top', legend.title = element_blank(), plot.margin = mars)

pleg <- g_legend(p4)
p4 <- p4 + theme(legend.position = 'none')

# final plot
grid.arrange(pleg, p2, p3, p4, ncol = 1, heights = c(0.15, 1, 1, 1))

@

\end{document}